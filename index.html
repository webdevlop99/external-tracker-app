<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>d'Amico Vessel External Audit Tracker</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              maritime: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
              },
            },
            fontFamily: {
              inter: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      * {
        font-family: "Inter", system-ui, sans-serif;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .dark ::-webkit-scrollbar-track {
        background: #374151;
      }

      ::-webkit-scrollbar-thumb {
        background: #9ca3af;
        border-radius: 4px;
      }

      .dark ::-webkit-scrollbar-thumb {
        background: #6b7280;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }

      /* Status colors */
      .status-valid {
        background-color: #dcfce7;
        color: #166534;
      }

      .dark .status-valid {
        background-color: #14532d;
        color: #bbf7d0;
      }

      .status-coming {
        background-color: #fef3c7;
        color: #92400e;
      }

      .dark .status-coming {
        background-color: #78350f;
        color: #fde68a;
      }

      .status-expired {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .dark .status-expired {
        background-color: #7f1d1d;
        color: #fecaca;
      }

      /* Chart container */
      #donutChart {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .dark #donutChart {
        background-color: #1f2937;
      }

      /* Sticky table headers */
      .sticky-header th {
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .sticky-first-col td:first-child,
      .sticky-first-col th:first-child {
        position: sticky;
        left: 0;
        z-index: 20;
        background-color: inherit;
      }

      /* Smooth transitions */
      .smooth-transition {
        transition: all 0.3s ease;
      }

      /* Modal backdrop */
      .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.5);
      }

      /* Pulse animation for alerts */
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      /* Certification pill styling */
      .cert-pill {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      /* Drag and drop styles */
      .drop-zone {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .drop-zone.drag-over {
        border-color: #0ea5e9;
        background-color: rgba(14, 165, 233, 0.1);
      }

      .drop-zone:hover {
        border-color: #0ea5e9;
      }

      /* Truncate remarks */
      /* Remarks styling */
      .remarks-cell {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        position: relative;
      }

      .remarks-cell:hover {
        text-decoration: underline;
        color: #0ea5e9;
      }

      .dark .remarks-cell:hover {
        color: #7dd3fc;
      }
      /* Modern approach (better browser support) */
      .remarks-cell-multi {
        max-width: 200px;
        display: -webkit-box;
        display: -moz-box;
        display: box;
        -webkit-line-clamp: 3;
        -moz-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        -moz-box-orient: vertical;
        box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4;
        max-height: 4.2em;
        cursor: pointer;
        word-break: break-word;
        white-space: normal;
      }

      .remarks-cell-multi:hover {
        color: #0ea5e9;
      }

      .dark .remarks-cell-multi:hover {
        color: #7dd3fc;
      }

      /* For single line remarks in overview table */
      .remarks-cell-single {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
      }

      .remarks-cell-single:hover {
        color: #0ea5e9;
        text-decoration: underline;
      }

      .dark .remarks-cell-single:hover {
        color: #7dd3fc;
      }

      /* Make sure the cell has enough height for 3 lines */
      td .remarks-cell-multi {
        min-height: 4.2em;
      }

      /* Small tooltip for quick view */
      .remarks-tooltip {
        visibility: hidden;
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        padding: 8px;
        border-radius: 4px;
        z-index: 100;
        max-width: 300px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        white-space: normal;
        word-wrap: break-word;
        top: 100%;
        left: 0;
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 12px;
        max-height: 150px;
        overflow-y: auto;
      }

      .remarks-cell:hover .remarks-tooltip {
        visibility: visible;
        opacity: 1;
      }

      .dark .remarks-tooltip {
        background: #1f2937;
        border-color: #374151;
      }

      /* Remarks Modal Styling */
      #remarksModal {
        backdrop-filter: blur(4px);
      }

      #remarksModal > div {
        max-height: 80vh;
        margin: auto;
      }

      #remarksContent {
        max-height: 50vh;
        overflow-y: auto;
        padding-right: 8px;
      }

      /* Custom scrollbar for remarks content */
      #remarksContent::-webkit-scrollbar {
        width: 6px;
      }

      #remarksContent::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }

      .dark #remarksContent::-webkit-scrollbar-track {
        background: #374151;
      }

      #remarksContent::-webkit-scrollbar-thumb {
        background: #9ca3af;
        border-radius: 3px;
      }

      .dark #remarksContent::-webkit-scrollbar-thumb {
        background: #6b7280;
      }

      /* Hidden import/export section */
      .hidden-section {
        display: none;
      }

      /* Password modal */
      #passwordModal {
        backdrop-filter: blur(4px);
      }
      /* Password Modal - Fixed Positioning */
      #passwordModal {
        backdrop-filter: blur(4px);
        z-index: 9999;
      }

      #passwordModal.hidden {
        display: none !important;
      }

      /* Ensure modal content is centered */
      #passwordModal > div {
        transform: translateY(0);
        opacity: 1;
        animation: modalFadeIn 0.3s ease-out;
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Lock/Unlock button states */
      #showHiddenSection.locked {
        background-color: #fef3c7;
        color: #92400e;
        border: 2px solid #f59e0b;
      }

      .dark #showHiddenSection.locked {
        background-color: #78350f;
        color: #fde68a;
        border: 2px solid #f59e0b;
      }

      #showHiddenSection.unlocked {
        background-color: #dcfce7;
        color: #166534;
        border: 2px solid #22c55e;
      }

      .dark #showHiddenSection.unlocked {
        background-color: #14532d;
        color: #bbf7d0;
        border: 2px solid #22c55e;
      }

      /* Loading animation */
      .loading {
        opacity: 0.7;
        pointer-events: none;
      }

      .loading::after {
        content: " ";
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #ccc;
        border-radius: 50%;
        border-top-color: #0ea5e9;
        animation: spin 1s ease-in-out infinite;
        margin-left: 10px;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Overview table - single line dates */
      .overview-date {
        white-space: nowrap;
        font-size: 11px;
      }

      /* Compact table styling */
      .compact-table th,
      .compact-table td {
        padding: 4px 8px;
      }
    </style>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <!-- Main Container -->
    <div class="min-h-screen p-4 md:p-6">
      <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
          <div
            class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6"
          >
            <div>
              <h1
                class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-maritime-600 to-blue-600 bg-clip-text text-transparent"
              >
                üö¢ Vessel External Audit Tracker
              </h1>
              <p class="text-gray-600 dark:text-gray-400 mt-2">
                SMC ‚Ä¢ ISPS ‚Ä¢ MLC Audit Tracker
              </p>
            </div>

            <div class="flex items-center gap-4">
              <!-- Database Status Indicator -->
              <div
                id="dbStatus"
                class="text-sm px-3 py-1 rounded-full bg-gray-100 dark:bg-gray-800 hidden"
              >
                <span class="flex items-center gap-2">
                  <span
                    class="w-2 h-2 rounded-full bg-green-500 animate-pulse"
                  ></span>
                  <span>Online</span>
                </span>
              </div>

              <!-- Show Hidden Section Button -->
              <!-- In the header section, update the Show Hidden Section Button -->
              <button
                id="showHiddenSection"
                class="flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 smooth-transition"
              >
                üîí Show Import/Export
              </button>

              <!-- Theme Toggle -->
              <button
                id="themeToggle"
                class="flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 smooth-transition"
              >
                <span class="hidden dark:inline">üåô Dark</span>
                <span class="dark:hidden">‚òÄÔ∏è Light</span>
              </button>

              <!-- Last Updated -->
              <div
                class="text-sm text-gray-500 dark:text-gray-400 hidden md:block"
              >
                Last updated: <span id="lastUpdated">Just now</span>
              </div>
            </div>
          </div>

          <!-- Navigation -->
          <nav class="border-b border-gray-200 dark:border-gray-700">
            <div class="flex space-x-1">
              <button
                id="navManagement"
                class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:border-maritime-500 hover:text-maritime-600 dark:hover:text-maritime-400 smooth-transition active-view"
              >
                üìä Management & Analytics
              </button>
              <button
                id="navOverview"
                class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:border-maritime-500 hover:text-maritime-600 dark:hover:text-maritime-400 smooth-transition"
              >
                üìã Compliance Overview
              </button>
              <button
                id="navImportExport"
                class="px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:border-maritime-500 hover:text-maritime-600 dark:hover:text-maritime-400 smooth-transition hidden-section"
              >
                üìÅ Import/Export
              </button>
            </div>
          </nav>
        </header>

        <!-- Main Content -->
        <main>
          <!-- View 1: Management & Analytics -->
          <div id="viewManagement" class="view-content space-y-6">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div
                id="cardValid"
                data-filter="valid"
                class="cursor-pointer summary-card status-valid p-6 rounded-xl border border-green-200 dark:border-green-900 smooth-transition hover:scale-[1.02]"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium">Fully Compliant</p>
                    <p class="text-3xl font-bold mt-2" id="countValid">0</p>
                  </div>
                  <div class="text-2xl">‚úÖ</div>
                </div>
              </div>

              <div
                id="cardComing"
                data-filter="coming"
                class="cursor-pointer summary-card status-coming p-6 rounded-xl border border-amber-200 dark:border-amber-900 smooth-transition hover:scale-[1.02]"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium">Coming Due (‚â§183 days)</p>
                    <p class="text-3xl font-bold mt-2" id="countComing">0</p>
                  </div>
                  <div class="text-2xl">‚ö†Ô∏è</div>
                </div>
              </div>

              <div
                id="cardExpired"
                data-filter="expired"
                class="cursor-pointer summary-card status-expired p-6 rounded-xl border border-red-200 dark:border-red-900 smooth-transition hover:scale-[1.02]"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium">Expired/Overdue</p>
                    <p class="text-3xl font-bold mt-2" id="countExpired">0</p>
                  </div>
                  <div class="text-2xl">‚ùå</div>
                </div>
              </div>
            </div>

            <!-- Single Donut Chart Section -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Status Overview</h3>
                <div class="flex gap-2">
                  <button
                    id="clearFilter"
                    class="text-sm text-maritime-600 dark:text-maritime-400 hover:underline"
                  >
                    Clear Filter
                  </button>
                  <button
                    id="toggleDays"
                    class="text-sm text-maritime-600 dark:text-maritime-400 hover:underline"
                  >
                    Show Days Remaining
                  </button>
                </div>
              </div>
              <div class="relative">
                <canvas id="donutChart" width="400" height="250"></canvas>
              </div>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-3">
                Click chart segments to filter vessels by status
              </p>
            </div>

            <!-- Form and Table Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <!-- Form -->
              <div
                class="lg:col-span-1 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"
              >
                <h3 class="text-lg font-semibold mb-4" id="formTitle">
                  ‚ûï Add New Vessel
                </h3>
                <form id="vesselForm" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium mb-2">
                      Vessel Name <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      id="vesselName"
                      required
                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-maritime-500 focus:border-transparent"
                      placeholder="Enter vessel name"
                    />
                  </div>

                  <!-- Certification Sections -->
                  <div id="certSections" class="space-y-4">
                    <!-- SMC, ISPS, MLC sections will be inserted here -->
                  </div>

                  <!-- Remarks Section -->
                  <div>
                    <label class="block text-sm font-medium mb-2">
                      Remarks / Notes
                    </label>
                    <textarea
                      id="remarks"
                      rows="3"
                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-maritime-500 focus:border-transparent resize-none"
                      placeholder="Add any notes or remarks about this vessel..."
                    ></textarea>
                  </div>

                  <div
                    class="flex items-center gap-3 pt-4 border-t border-gray-200 dark:border-gray-700"
                  >
                    <button
                      type="submit"
                      id="submitButton"
                      class="px-4 py-2 bg-maritime-600 text-white rounded-lg hover:bg-maritime-700 smooth-transition flex items-center"
                    >
                      <span id="submitText">Save Vessel</span>
                      <span id="submitSpinner" class="hidden ml-2">
                        <div
                          class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"
                        ></div>
                      </span>
                    </button>
                    <button
                      type="button"
                      id="cancelEdit"
                      class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 smooth-transition hidden"
                    >
                      Cancel
                    </button>
                    <button
                      type="button"
                      id="clearForm"
                      class="ml-auto text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 smooth-transition"
                    >
                      Clear Form
                    </button>
                  </div>
                </form>
              </div>

              <!-- Table -->
              <div
                class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold">Vessel Management</h3>
                  <div class="flex items-center gap-4">
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                      Showing
                      <span id="filteredCount" class="font-bold">0</span> of
                      <span id="totalVessels" class="font-bold">0</span> vessels
                    </div>
                    <button
                      id="refreshData"
                      class="text-sm text-maritime-600 dark:text-maritime-400 hover:underline flex items-center gap-1"
                    >
                      üîÑ Refresh
                    </button>
                  </div>
                </div>

                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-700 sticky-header">
                      <tr>
                        <th
                          class="p-3 text-left text-xs font-medium uppercase tracking-wider"
                        >
                          Vessel
                        </th>
                        <th
                          class="p-3 text-left text-xs font-medium uppercase tracking-wider"
                        >
                          SMC (Issue/Int/Exp)
                        </th>
                        <th
                          class="p-3 text-left text-xs font-medium uppercase tracking-wider"
                        >
                          ISPS (Issue/Int/Exp)
                        </th>
                        <th
                          class="p-3 text-left text-xs font-medium uppercase tracking-wider"
                        >
                          MLC (Issue/Int/Exp)
                        </th>
                        <th
                          class="p-3 text-left text-xs font-medium uppercase tracking-wider"
                        >
                          Remarks
                        </th>
                        <th
                          class="p-3 text-left text-xs font-medium uppercase tracking-wider"
                        >
                          Actions
                        </th>
                      </tr>
                    </thead>
                    <tbody
                      id="vesselTableBody"
                      class="divide-y divide-gray-200 dark:divide-gray-700"
                    >
                      <!-- Vessel rows will be inserted here -->
                    </tbody>
                  </table>
                </div>

                <div id="emptyState" class="text-center py-12 hidden">
                  <div class="text-4xl mb-4">üö¢</div>
                  <h4 class="text-lg font-medium mb-2">No vessels found</h4>
                  <p class="text-gray-600 dark:text-gray-400 mb-4">
                    Add your first vessel using the form or import from CSV
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- View 2: Compliance Overview -->
          <div id="viewOverview" class="view-content hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h3 class="text-lg font-semibold">
                    Compliance Overview Dashboard
                  </h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    All dates are automatically color-coded based on compliance
                    status
                  </p>
                </div>
                <div class="flex gap-2 items-center">
                  <!-- Search Bar -->
                  <div class="relative">
                    <input
                      type="text"
                      id="searchVessels"
                      placeholder="Search vessels..."
                      class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-maritime-500 focus:border-transparent w-64"
                    />
                    <div class="absolute left-3 top-2.5 text-gray-400">üîç</div>
                  </div>
                  <button
                    id="toggleDaysOverview"
                    class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 smooth-transition text-sm"
                  >
                    Show Days Remaining
                  </button>
                </div>
              </div>

              <div class="overflow-x-auto">
                <table class="w-full compact-table">
                  <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                      <th
                        class="p-2 text-left text-xs font-medium uppercase tracking-wider border-b border-gray-200 dark:border-gray-600"
                      >
                        Vessel Name
                      </th>
                      <!-- SMC -->
                      <th
                        colspan="3"
                        class="p-2 text-center text-xs font-medium uppercase tracking-wider border-b border-gray-200 dark:border-gray-600 bg-blue-50 dark:bg-blue-900/30"
                      >
                        SMC
                      </th>
                      <!-- ISPS -->
                      <th
                        colspan="3"
                        class="p-2 text-center text-xs font-medium uppercase tracking-wider border-b border-gray-200 dark:border-gray-600 bg-green-50 dark:bg-green-900/30"
                      >
                        ISPS
                      </th>
                      <!-- MLC -->
                      <th
                        colspan="3"
                        class="p-2 text-center text-xs font-medium uppercase tracking-wider border-b border-gray-200 dark:border-gray-600 bg-purple-50 dark:bg-purple-900/30"
                      >
                        MLC
                      </th>
                      <!-- Remarks -->
                      <th
                        class="p-2 text-left text-xs font-medium uppercase tracking-wider border-b border-gray-200 dark:border-gray-600"
                      >
                        Remarks
                      </th>
                    </tr>
                    <tr>
                      <th
                        class="p-2 text-left text-xs font-medium uppercase tracking-wider"
                      ></th>
                      <!-- SMC Subheaders -->
                      <th class="p-2 text-center text-xs font-medium uppercase">
                        Issue
                      </th>
                      <th class="p-2 text-center text-xs font-medium uppercase">
                        Int
                      </th>
                      <th class="p-2 text-center text-xs font-medium uppercase">
                        Expiry
                      </th>
                      <!-- ISPS Subheaders -->
                      <th class="p-2 text-center text-xs font-medium uppercase">
                        Issue
                      </th>
                      <th class="p-2 text-center text-xs font-medium uppercase">
                        Int
                      </th>
                      <th class="p-2 text-center text-xs font-medium uppercase">
                        Expiry
                      </th>
                      <!-- MLC Subheaders -->
                      <th class="p-2 text-center text-xs font-medium uppercase">
                        Issue
                      </th>
                      <th class="p-2 text-center text-xs font-medium uppercase">
                        Int
                      </th>
                      <th class="p-2 text-center text-xs font-medium uppercase">
                        Expiry
                      </th>
                      <!-- Remarks Header -->
                      <th
                        class="p-2 text-left text-xs font-medium uppercase"
                      ></th>
                    </tr>
                  </thead>
                  <tbody
                    id="overviewTableBody"
                    class="divide-y divide-gray-200 dark:divide-gray-700"
                  >
                    <!-- Overview rows will be inserted here -->
                  </tbody>
                </table>
              </div>
              <div id="noSearchResults" class="text-center py-12 hidden">
                <div class="text-4xl mb-4">üîç</div>
                <h4 class="text-lg font-medium mb-2">No vessels found</h4>
                <p class="text-gray-600 dark:text-gray-400">
                  Try a different search term
                </p>
              </div>
            </div>
          </div>

          <!-- View 3: Import/Export - Hidden by default -->
          <div id="viewImportExport" class="view-content hidden hidden-section">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Import Section -->
              <div
                id="importSection"
                class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"
              >
                <h3 class="text-lg font-semibold mb-4">üì• Import Data</h3>
                <div class="space-y-4">
                  <div class="drop-zone" id="dropZone">
                    <input
                      type="file"
                      id="csvFileInput"
                      accept=".csv"
                      class="hidden"
                    />
                    <div class="text-4xl mb-4">üìÅ</div>
                    <p class="mb-2">Drag & drop CSV file here</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                      Supports .csv files with vessel certification data
                    </p>
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                      <p class="mb-1">‚úì Only drag & drop is supported</p>
                      <p>‚úì No click to browse available</p>
                    </div>
                  </div>

                  <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                    <h4 class="font-medium mb-2">CSV Format Requirements:</h4>
                    <ul
                      class="text-sm text-gray-600 dark:text-gray-400 space-y-1"
                    >
                      <li>
                        ‚Ä¢ Required columns: <code>name</code>,
                        <code>remarks</code> (optional)
                      </li>
                      <li>
                        ‚Ä¢ Date columns: <code>smc_issue</code>,
                        <code>smc_expiry</code>,
                        <code>smc_intermediatedue</code>, etc.
                      </li>
                      <li>
                        ‚Ä¢ Dates in YYYY-MM-DD format (auto-converted from other
                        formats)
                      </li>
                      <li>
                        ‚Ä¢ Boolean columns:
                        <code>smc_intermediatecompleted</code>
                        (true/false/yes/no/1/0)
                      </li>
                      <li>‚Ä¢ Existing vessels will be updated based on name</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Export Section -->
              <div
                id="exportSection"
                class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"
              >
                <h3 class="text-lg font-semibold mb-4">üì§ Export Data</h3>
                <div class="space-y-4">
                  <button
                    id="exportCSV"
                    class="w-full p-6 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 smooth-transition flex items-center justify-between"
                  >
                    <div class="text-left">
                      <div class="text-2xl mb-2">üìÑ</div>
                      <h4 class="font-medium">Export as CSV</h4>
                      <p class="text-sm text-gray-600 dark:text-gray-400">
                        Download all vessel data in spreadsheet format
                      </p>
                    </div>
                    <div class="text-2xl">‚¨áÔ∏è</div>
                  </button>

                  <button
                    id="exportPDF"
                    class="w-full p-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 smooth-transition flex items-center justify-between"
                  >
                    <div class="text-left">
                      <div class="text-2xl mb-2">üìä</div>
                      <h4 class="font-medium">Generate Compliance Report</h4>
                      <p class="text-sm text-gray-600 dark:text-gray-400">
                        Create overview report with color-coded status
                      </p>
                    </div>
                    <div class="text-2xl">üñ®Ô∏è</div>
                  </button>

                  <div
                    class="border-t border-gray-200 dark:border-gray-700 pt-4"
                  >
                    <button
                      id="syncToDatabase"
                      class="w-full p-4 bg-blue-100 dark:bg-blue-900 border border-blue-300 dark:border-blue-800 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 smooth-transition text-blue-600 dark:text-blue-400 mb-2"
                    >
                      üíæ Sync to Database
                    </button>
                    <button
                      id="clearAllData"
                      class="w-full p-4 bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-800 smooth-transition text-red-600 dark:text-red-400"
                    >
                      üóëÔ∏è Clear All Data
                    </button>
                    <p
                      class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center"
                    >
                      This will permanently delete all vessel records
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>

        <!-- Footer -->
        <footer
          class="mt-12 pt-6 border-t border-gray-200 dark:border-gray-700"
        >
          <div
            class="flex flex-col md:flex-row justify-between items-center gap-4"
          >
            <div class="text-sm text-gray-600 dark:text-gray-400">
              <p>Vessel External Audit Tracker</p>
              <p class="mt-1">All dates and times in UTC</p>
            </div>
            <div class="text-xs text-gray-500 dark:text-gray-500">
              <span id="dbSyncStatus">Database: Offline</span> ‚Ä¢ Refresh to
              update status
            </div>
          </div>
        </footer>
      </div>
    </div>

    <!-- Password Modal -->
    <!-- Password Modal -->
    <div
      id="passwordModal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-backdrop"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6 mx-auto my-auto"
      >
        <h3 class="text-lg font-semibold mb-4">üîí Password Required</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">
              Enter Password to Show Import/Export Section
            </label>
            <input
              type="password"
              id="sectionPassword"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-maritime-500 focus:border-transparent"
              placeholder="Enter password..."
              autocomplete="off"
            />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
              Default password: <code>show123</code> (change for production)
            </p>
          </div>

          <div class="flex justify-end gap-3 pt-4">
            <button
              id="cancelPassword"
              type="button"
              class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 smooth-transition"
            >
              Cancel
            </button>
            <button
              id="submitPassword"
              type="button"
              class="px-4 py-2 bg-maritime-600 text-white rounded-lg hover:bg-maritime-700 smooth-transition"
            >
              Unlock
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Import Modal -->
    <div
      id="importModal"
      class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6"
      >
        <h3 class="text-lg font-semibold mb-4">Processing Import</h3>
        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <div
              class="w-8 h-8 border-4 border-maritime-200 border-t-maritime-600 rounded-full animate-spin"
            ></div>
            <div>
              <p class="font-medium">Reading CSV file...</p>
              <p
                class="text-sm text-gray-600 dark:text-gray-400"
                id="importStatus"
              ></p>
            </div>
          </div>

          <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
            <div class="flex justify-between text-sm mb-2">
              <span>Processing</span>
              <span id="importProgress">0/0</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div
                id="importProgressBar"
                class="bg-maritime-600 h-2 rounded-full transition-all duration-300"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <div id="importResults" class="hidden">
            <div class="grid grid-cols-3 gap-4 text-sm">
              <div
                class="text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg"
              >
                <p
                  class="font-medium text-green-700 dark:text-green-300"
                  id="importAdded"
                >
                  0
                </p>
                <p class="text-gray-600 dark:text-gray-400">Added</p>
              </div>
              <div
                class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg"
              >
                <p
                  class="font-medium text-blue-700 dark:text-blue-300"
                  id="importUpdated"
                >
                  0
                </p>
                <p class="text-gray-600 dark:text-gray-400">Updated</p>
              </div>
              <div
                class="text-center p-3 bg-gray-100 dark:bg-gray-800 rounded-lg"
              >
                <p
                  class="font-medium text-gray-700 dark:text-gray-300"
                  id="importSkipped"
                >
                  0
                </p>
                <p class="text-gray-600 dark:text-gray-400">Skipped</p>
              </div>
            </div>
          </div>

          <div class="flex justify-end gap-3 pt-4">
            <button
              id="cancelImport"
              class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 smooth-transition"
            >
              Cancel
            </button>
            <button
              id="confirmImport"
              class="px-4 py-2 bg-maritime-600 text-white rounded-lg hover:bg-maritime-700 smooth-transition hidden"
            >
              Complete Import
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Container -->
    <div
      id="notificationContainer"
      class="fixed top-4 right-4 z-50 space-y-2"
    ></div>

    <script>
      // ============================================================================
      // CONSTANTS AND CONFIGURATION
      // ============================================================================
      const CERTS = ["smc", "isps", "mlc"];
      const CERT_LABELS = {
        smc: "Safety Management Certificate (SMC)",
        isps: "International Ship Security Certificate (ISPS)",
        mlc: "Maritime Labour Certificate (MLC)",
      };
      const CERT_SHORT = {
        smc: "SMC",
        isps: "ISPS",
        mlc: "MLC",
      };
      const STORAGE_KEY = "vessel_compliance_data_v7";
      const TODAY = new Date();
      TODAY.setHours(0, 0, 0, 0);
      const MS_IN_DAY = 1000 * 60 * 60 * 24;
      const WARNING_DAYS = 183;

      // Password to show hidden import/export section
      const SECTION_PASSWORD = "show123";

      // ============================================================================
      // SUPABASE CONFIGURATION
      // ============================================================================
      // Replace these with your Supabase project credentials
      const SUPABASE_URL = "https://wjaopdggrxmdvtutvurg.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqYW9wZGdncnhtZHZ0dXR2dXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MzQ2NDksImV4cCI6MjA4MDUxMDY0OX0.qYS2vv2rWhmPdCECT9EKtFlm2YYcL-OYKDn2r37XFpA";
      const TABLE_NAME = "vessels";

      // Initialize Supabase client
      let supabase = null;
      let isSupabaseConnected = false;

      if (
        SUPABASE_URL &&
        SUPABASE_ANON_KEY &&
        SUPABASE_URL !== "https://your-project.supabase.co" &&
        SUPABASE_ANON_KEY !== "your-anon-key"
      ) {
        supabase = window.supabase.createClient(
          SUPABASE_URL,
          SUPABASE_ANON_KEY
        );
        isSupabaseConnected = true;
        console.log("Supabase connected");
      } else {
        console.warn("Supabase not configured. Using local storage only.");
      }

      // ============================================================================
      // STATE MANAGEMENT
      // ============================================================================
      let vessels = [];
      let editId = null;
      let editDbId = null;
      let currentFilter = null;
      let currentView = "management";
      let showDaysRemaining = false;
      let chartSegments = [];
      let isHiddenSectionVisible = false;
      let searchQuery = "";

      // ============================================================================
      // INITIALIZATION
      // ============================================================================
      document.addEventListener("DOMContentLoaded", () => {
        initializeApp();
      });

      async function initializeApp() {
        loadData();
        initializeTheme();
        renderCertSections();
        setupEventListeners();
        setupDragAndDrop();
        setupRemarksModal(); // Add this line
        updateLastUpdated();

        // Try to load from database first
        if (isSupabaseConnected) {
          await loadFromDatabase();
          updateDatabaseStatus(true);
        } else {
          renderAll();
        }
      }

      // ============================================================================
      // DATABASE FUNCTIONS
      // ============================================================================
      async function loadFromDatabase() {
        if (!isSupabaseConnected) return;

        try {
          showNotification("Loading data from database...", "info");

          const { data, error } = await supabase
            .from(TABLE_NAME)
            .select("*")
            .order("name", { ascending: true });

          if (error) {
            console.error("Error loading from database:", error);
            showNotification("Using local data", "warning");
            renderAll();
            return;
          }

          if (data && data.length > 0) {
            // Clear existing vessels
            vessels = [];

            // Convert database format to app format
            data.forEach((item) => {
              const vessel = {
                id: item.name.toLowerCase().replace(/[^a-z0-9]/g, "-"), // Create ID from name
                db_id: item.id,
                name: item.name,
                remarks: item.remarks || "",
                createdAt: item.created_at,
                updatedAt: item.updated_at,
                smc: {
                  issue: item.smc_issue,
                  expiry: item.smc_expiry,
                  intermediateDue: item.smc_intermediate_due,
                  intermediateCompleted:
                    item.smc_intermediate_completed || false,
                },
                isps: {
                  issue: item.isps_issue,
                  expiry: item.isps_expiry,
                  intermediateDue: item.isps_intermediate_due,
                  intermediateCompleted:
                    item.isps_intermediate_completed || false,
                },
                mlc: {
                  issue: item.mlc_issue,
                  expiry: item.mlc_expiry,
                  intermediateDue: item.mlc_intermediate_due,
                  intermediateCompleted:
                    item.mlc_intermediate_completed || false,
                },
              };
              vessels.push(vessel);
            });

            saveData(); // Save to local storage as backup
            showNotification(
              `Loaded ${vessels.length} vessels from database`,
              "success"
            );
          } else {
            showNotification(
              "No data in database. Using local storage.",
              "info"
            );
          }

          renderAll();
        } catch (error) {
          console.error("Database load error:", error);
          showNotification(
            "Database connection failed. Using local data.",
            "error"
          );
          renderAll();
        }
      }

      async function saveVesselToDatabase(vesselData) {
        if (!isSupabaseConnected) return null;

        try {
          const dbData = {
            name: vesselData.name.trim(),
            remarks: vesselData.remarks || "",
            smc_issue: vesselData.smc?.issue || null,
            smc_expiry: vesselData.smc?.expiry || null,
            smc_intermediate_due: vesselData.smc?.intermediateDue || null,
            smc_intermediate_completed:
              vesselData.smc?.intermediateCompleted || false,
            isps_issue: vesselData.isps?.issue || null,
            isps_expiry: vesselData.isps?.expiry || null,
            isps_intermediate_due: vesselData.isps?.intermediateDue || null,
            isps_intermediate_completed:
              vesselData.isps?.intermediateCompleted || false,
            mlc_issue: vesselData.mlc?.issue || null,
            mlc_expiry: vesselData.mlc?.expiry || null,
            mlc_intermediate_due: vesselData.mlc?.intermediateDue || null,
            mlc_intermediate_completed:
              vesselData.mlc?.intermediateCompleted || false,
            updated_at: new Date().toISOString(),
          };

          let result;

          // Check if vessel already exists by name (case-insensitive)
          const { data: existingVessel, error: searchError } = await supabase
            .from(TABLE_NAME)
            .select("*")
            .ilike("name", vesselData.name.trim())
            .limit(1);

          if (searchError) throw searchError;

          if (existingVessel && existingVessel.length > 0) {
            const existing = existingVessel[0];

            // Check if we're trying to update a different vessel with the same name
            if (vesselData.db_id && vesselData.db_id !== existing.id) {
              showNotification(
                `Vessel '${vesselData.name}' already exists with different ID`,
                "error"
              );
              return null;
            }

            // Update existing vessel
            const { data, error } = await supabase
              .from(TABLE_NAME)
              .update(dbData)
              .eq("id", existing.id)
              .select();

            if (error) throw error;
            result = data?.[0];
          } else {
            // Insert new vessel
            dbData.created_at = new Date().toISOString();

            const { data, error } = await supabase
              .from(TABLE_NAME)
              .insert([dbData])
              .select();

            if (error) {
              if (
                error.message.includes("unique constraint") ||
                error.code === "23505"
              ) {
                showNotification(
                  `Vessel '${vesselData.name}' already exists`,
                  "error"
                );
                return null;
              }
              throw error;
            }
            result = data?.[0];
          }

          return result;
        } catch (error) {
          console.error("Database save error:", error);

          if (error.code === "23505") {
            showNotification(
              `Vessel '${vesselData.name}' already exists in database`,
              "error"
            );
          } else {
            showNotification("Failed to save to database", "error");
          }
          return null;
        }
      }

      async function deleteVesselFromDatabase(vesselName) {
        if (!isSupabaseConnected) return false;

        try {
          const { error } = await supabase
            .from(TABLE_NAME)
            .delete()
            .ilike("name", vesselName);

          if (error) throw error;
          return true;
        } catch (error) {
          console.error("Database delete error:", error);
          showNotification("Failed to delete from database", "error");
          return false;
        }
      }

      async function batchImportToDatabase(vesselsToImport) {
        if (!isSupabaseConnected) {
          showNotification("Database not configured", "error");
          return { success: false };
        }

        try {
          showNotification(
            `Importing ${vesselsToImport.length} vessels to database...`,
            "info"
          );

          const results = {
            added: 0,
            updated: 0,
            skipped: 0,
            errors: [],
          };

          // Process vessels one by one to handle conflicts
          for (const vessel of vesselsToImport) {
            try {
              // Check if vessel already exists locally
              const existingLocalIndex = vessels.findIndex(
                (v) => v.name.toLowerCase() === vessel.name.toLowerCase()
              );

              if (existingLocalIndex !== -1) {
                // Update existing vessel with imported data
                const existingVessel = vessels[existingLocalIndex];

                // Merge data (prefer imported data)
                const mergedVessel = {
                  ...existingVessel,
                  name: vessel.name,
                  remarks: vessel.remarks || existingVessel.remarks,
                  smc: { ...existingVessel.smc, ...vessel.smc },
                  isps: { ...existingVessel.isps, ...vessel.isps },
                  mlc: { ...existingVessel.mlc, ...vessel.mlc },
                };

                // Save to database
                const result = await saveVesselToDatabase(mergedVessel);
                if (result) {
                  vessels[existingLocalIndex] = mergedVessel;
                  results.updated++;
                } else {
                  results.skipped++;
                }
              } else {
                // Save new vessel to database
                const result = await saveVesselToDatabase(vessel);
                if (result) {
                  vessels.push(vessel);
                  results.added++;
                } else {
                  results.skipped++;
                }
              }
            } catch (error) {
              console.error(`Error importing vessel ${vessel.name}:`, error);
              results.errors.push(vessel.name);
              results.skipped++;
            }
          }

          saveData(); // Save to local storage

          if (results.errors.length === 0) {
            showNotification(
              `Import complete: ${results.added} added, ${results.updated} updated, ${results.skipped} skipped`,
              "success"
            );
          } else {
            showNotification(
              `Import complete with ${results.errors.length} errors`,
              "warning"
            );
          }

          return { success: true, ...results };
        } catch (error) {
          console.error("Batch import error:", error);
          showNotification("Import failed", "error");
          return { success: false, errors: [error.message] };
        }
      }

      function updateDatabaseStatus(connected) {
        const statusElement = document.getElementById("dbSyncStatus");
        const dbStatus = document.getElementById("dbStatus");

        if (connected) {
          statusElement.textContent = "Database: Online";
          statusElement.classList.add("text-green-600", "dark:text-green-400");
          dbStatus.classList.remove("hidden");
        } else {
          statusElement.textContent = "Database: Offline";
          statusElement.classList.remove(
            "text-green-600",
            "dark:text-green-400"
          );
          dbStatus.classList.add("hidden");
        }
      }

      // ============================================================================
      // HIDDEN SECTION MANAGEMENT - FIXED
      // ============================================================================
      function showHiddenSection() {
        isHiddenSectionVisible = true;

        // Show the import/export navigation button
        document
          .getElementById("navImportExport")
          .classList.remove("hidden-section");

        // Change button icon and text
        const showButton = document.getElementById("showHiddenSection");
        showButton.innerHTML = "üîì Import/Export Visible";
        showButton.classList.remove("locked");
        showButton.classList.add("unlocked");

        // If we're already on the import/export view, show it
        if (currentView === "importExport") {
          document
            .getElementById("viewImportExport")
            .classList.remove("hidden-section");
        }

        showNotification("Import/Export section is now visible", "success");
      }

      function checkHiddenSectionPassword() {
        if (isHiddenSectionVisible) {
          showHiddenSection();
          return true;
        }

        // Show password modal in center
        const modal = document.getElementById("passwordModal");
        modal.classList.remove("hidden");

        // Focus on the password input
        setTimeout(() => {
          document.getElementById("sectionPassword").focus();
        }, 100);

        return false;
      }

      // ============================================================================
      // DATA PERSISTENCE
      // ============================================================================
      function loadData() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          vessels = stored ? JSON.parse(stored) : [];
          console.log(`Loaded ${vessels.length} vessels from storage`);
        } catch (error) {
          console.error("Error loading data:", error);
          vessels = [];
        }
      }

      function saveData() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(vessels));
          updateLastUpdated();
        } catch (error) {
          console.error("Error saving data:", error);
        }
      }

      // ============================================================================
      // THEME MANAGEMENT
      // ============================================================================
      function initializeTheme() {
        const isDark =
          localStorage.getItem("darkMode") === "true" ||
          (!localStorage.getItem("darkMode") &&
            window.matchMedia("(prefers-color-scheme: dark)").matches);

        if (isDark) {
          document.documentElement.classList.add("dark");
        }

        document
          .getElementById("themeToggle")
          .addEventListener("click", toggleTheme);
      }

      function toggleTheme() {
        const isDark = document.documentElement.classList.toggle("dark");
        localStorage.setItem("darkMode", isDark);
        renderChart(); // Redraw chart with correct colors
      }

      // ============================================================================
      // FORM MANAGEMENT
      // ============================================================================
      function renderCertSections() {
        const container = document.getElementById("certSections");
        container.innerHTML = "";

        CERTS.forEach((cert) => {
          const section = document.createElement("div");
          section.className =
            "border border-gray-200 dark:border-gray-700 rounded-lg p-4";
          section.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-medium">${CERT_SHORT[cert]}</h4>
                        <span class="text-xs text-gray-500">${CERT_LABELS[cert]}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">
                                Issue Date <span class="text-red-500">*</span>
                            </label>
                            <input type="date" 
                                   id="${cert}-issue" 
                                   required
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-maritime-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">
                                Expiry Date <span class="text-red-500">*</span>
                            </label>
                            <input type="date" 
                                   id="${cert}-expiry" 
                                   required
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-maritime-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">
                                Intermediate Due
                            </label>
                            <input type="date" 
                                   id="${cert}-intermediateDue" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-maritime-500 focus:border-transparent">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" 
                                   id="${cert}-intermediateCompleted" 
                                   class="h-4 w-4 rounded border-gray-300 text-maritime-600 focus:ring-maritime-500">
                            <label for="${cert}-intermediateCompleted" class="ml-2 text-sm">
                                Intermediate Completed
                            </label>
                        </div>
                    </div>
                `;
          container.appendChild(section);
        });

        setupDateCalculations();
      }

      function setupDateCalculations() {
        CERTS.forEach((cert) => {
          const issueInput = document.getElementById(`${cert}-issue`);
          const expiryInput = document.getElementById(`${cert}-expiry`);
          const intermediateInput = document.getElementById(
            `${cert}-intermediateDue`
          );

          const calculateHandler = () => {
            const issueDate = issueInput.value;
            const expiryDate = expiryInput.value;

            if (issueDate && expiryDate && !intermediateInput.value) {
              const midpoint = calculateMidpoint(issueDate, expiryDate);
              if (midpoint) {
                intermediateInput.value = midpoint;
              }
            }
          };

          issueInput.addEventListener("change", calculateHandler);
          expiryInput.addEventListener("change", calculateHandler);
        });
      }

      // ============================================================================
      // DRAG AND DROP FUNCTIONALITY - SIMPLIFIED
      // ============================================================================
      function setupDragAndDrop() {
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("csvFileInput");

        // Remove all click handlers - only drag & drop
        dropZone.addEventListener("click", (e) => {
          e.stopPropagation();
          // Do nothing on click - only drag & drop
        });

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          dropZone.addEventListener(eventName, highlight, false);
        });

        ["dragleave", "drop"].forEach((eventName) => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
          dropZone.classList.add("drag-over");
        }

        function unhighlight() {
          dropZone.classList.remove("drag-over");
        }

        dropZone.addEventListener("drop", function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;

          if (files.length > 0) {
            const file = files[0];
            if (file.name.toLowerCase().endsWith(".csv")) {
              fileInput.files = files;
              handleFileSelect({ target: fileInput });
            } else {
              showNotification("Please drop a CSV file only", "error");
            }
          }
        });
      }

      // ============================================================================
      // DATE UTILITIES
      // ============================================================================
      function normalizeDate(dateStr) {
        if (!dateStr || dateStr.trim() === "") return null;

        // Clean the string
        dateStr = dateStr.trim();

        // Check if it's already in ISO format (YYYY-MM-DD)
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
          const date = new Date(dateStr);
          if (!isNaN(date.getTime())) {
            date.setHours(0, 0, 0, 0);
            return date.toISOString().split("T")[0];
          }
        }

        // Try parsing DD/MM/YYYY or DD-MM-YYYY
        const dmy = dateStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
        if (dmy) {
          const day = dmy[1].padStart(2, "0");
          const month = dmy[2].padStart(2, "0");
          const year = dmy[3];
          const isoDate = `${year}-${month}-${day}`;
          const date = new Date(isoDate);
          if (!isNaN(date.getTime())) {
            date.setHours(0, 0, 0, 0);
            return date.toISOString().split("T")[0];
          }
        }

        // Try parsing YYYY/MM/DD or YYYY-MM-DD
        const ymd = dateStr.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
        if (ymd) {
          const year = ymd[1];
          const month = ymd[2].padStart(2, "0");
          const day = ymd[3].padStart(2, "0");
          const isoDate = `${year}-${month}-${day}`;
          const date = new Date(isoDate);
          if (!isNaN(date.getTime())) {
            date.setHours(0, 0, 0, 0);
            return date.toISOString().split("T")[0];
          }
        }

        // Try parsing with Date object (fallback)
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
          date.setHours(0, 0, 0, 0);
          return date.toISOString().split("T")[0];
        }

        console.warn(`Could not parse date: ${dateStr}`);
        return null;
      }

      function formatDate(dateStr) {
        if (!dateStr) return "-";
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        return date.toLocaleDateString("en-CA");
      }

      function formatDateForOverview(dateStr) {
        if (!dateStr) return "-";
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;

        const day = date.getDate();
        const monthNames = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();

        return `${day}-${month}-${year}`;
      }

      function daysBetween(date1, date2) {
        const d1 = new Date(date1);
        const d2 = new Date(date2);
        d1.setHours(0, 0, 0, 0);
        d2.setHours(0, 0, 0, 0);
        const diff = d2.getTime() - d1.getTime();
        return Math.floor(diff / MS_IN_DAY);
      }

      function calculateMidpoint(startStr, endStr) {
        if (!startStr || !endStr) return null;

        const start = new Date(startStr);
        const end = new Date(endStr);

        if (isNaN(start.getTime()) || isNaN(end.getTime())) return null;

        const midpoint = new Date((start.getTime() + end.getTime()) / 2);
        midpoint.setHours(0, 0, 0, 0);
        return midpoint.toISOString().split("T")[0];
      }

      // ============================================================================
      // COMPLIANCE LOGIC
      // ============================================================================
      function getDateStatus(
        dateStr,
        isIntermediate = false,
        isCompleted = false
      ) {
        if (!dateStr)
          return {
            status: "valid",
            label: "No date",
            color: "gray",
            daysUntil: null,
          };

        const date = new Date(dateStr);
        if (isNaN(date.getTime()))
          return {
            status: "valid",
            label: "Invalid",
            color: "gray",
            daysUntil: null,
          };

        const daysUntil = daysBetween(
          TODAY.toISOString().split("T")[0],
          dateStr
        );

        // Special case: Intermediate completed - ALWAYS GREEN
        if (isIntermediate && isCompleted) {
          return {
            status: "valid",
            label: "Completed",
            color: "green",
            daysUntil: daysUntil,
          };
        }

        // Expired/Overdue
        if (daysUntil < 0) {
          return {
            status: "expired",
            label: isIntermediate ? "Overdue" : "Expired",
            color: "red",
            daysUntil: Math.abs(daysUntil),
          };
        }

        // Coming due (within 183 days)
        if (daysUntil <= WARNING_DAYS) {
          const labelText = daysUntil === 0 ? "Today" : `${daysUntil} days`;
          return {
            status: "coming",
            label: labelText,
            color: "amber",
            daysUntil: daysUntil,
          };
        }

        // Valid (more than 90 days away)
        return {
          status: "valid",
          label: "Valid",
          color: "green",
          daysUntil: daysUntil,
        };
      }

      function getCertStatus(certData) {
        if (!certData)
          return {
            status: "valid",
            label: "No data",
            color: "gray",
          };

        const expiryStatus = getDateStatus(certData.expiry, false, false);
        const intermediateStatus = getDateStatus(
          certData.intermediateDue,
          true,
          certData.intermediateCompleted
        );

        // Most critical status wins
        const statusPriority = { expired: 3, coming: 2, valid: 1, unknown: 0 };

        const finalStatus = [expiryStatus, intermediateStatus]
          .filter((s) => s.status !== "unknown")
          .sort(
            (a, b) => statusPriority[b.status] - statusPriority[a.status]
          )[0];

        return (
          finalStatus || { status: "valid", label: "No dates", color: "gray" }
        );
      }

      function getVesselStatus(vessel) {
        if (!vessel) return { status: "valid", label: "No vessel" };

        const certStatuses = CERTS.map((cert) => getCertStatus(vessel[cert]));
        const statusPriority = { expired: 3, coming: 2, valid: 1, unknown: 0 };

        const vesselStatus = certStatuses
          .filter((s) => s.status !== "unknown")
          .sort(
            (a, b) => statusPriority[b.status] - statusPriority[a.status]
          )[0];

        return vesselStatus || { status: "valid", label: "All valid" };
      }

      // ============================================================================
      // RENDERING FUNCTIONS
      // ============================================================================
      function renderAll() {
        updateSummaryCards();
        renderManagementTable();
        renderOverviewTable();
        renderChart();
        updateCounts();
      }

      function updateSummaryCards() {
        const counts = { valid: 0, coming: 0, expired: 0 };

        vessels.forEach((vessel) => {
          const status = getVesselStatus(vessel);
          if (status.status in counts) {
            counts[status.status]++;
          }
        });

        document.getElementById("countValid").textContent = counts.valid;
        document.getElementById("countComing").textContent = counts.coming;
        document.getElementById("countExpired").textContent = counts.expired;
      }

      function renderManagementTable() {
        const tbody = document.getElementById("vesselTableBody");
        const emptyState = document.getElementById("emptyState");

        if (vessels.length === 0) {
          tbody.innerHTML = "";
          emptyState.classList.remove("hidden");
          return;
        }

        emptyState.classList.add("hidden");

        // Filter vessels if needed
        let filteredVessels = vessels;
        if (currentFilter) {
          filteredVessels = vessels.filter((vessel) => {
            const status = getVesselStatus(vessel);
            return status.status === currentFilter;
          });
        }

        // Update counts
        document.getElementById("filteredCount").textContent =
          filteredVessels.length;
        document.getElementById("totalVessels").textContent = vessels.length;

        // Sort by status priority then name
        filteredVessels.sort((a, b) => {
          const statusPriority = { expired: 3, coming: 2, valid: 1 };
          const aStatus = getVesselStatus(a);
          const bStatus = getVesselStatus(b);

          const aPriority = statusPriority[aStatus.status] || 0;
          const bPriority = statusPriority[bStatus.status] || 0;

          if (aPriority !== bPriority) {
            return bPriority - aPriority;
          }

          return a.name.localeCompare(b.name);
        });

        // Render rows
        tbody.innerHTML = "";

        filteredVessels.forEach((vessel) => {
          const vesselStatus = getVesselStatus(vessel);
          const row = document.createElement("tr");
          row.className =
            "hover:bg-gray-50 dark:hover:bg-gray-700 smooth-transition";

          let rowClass = "";
          switch (vesselStatus.status) {
            case "expired":
              rowClass = "status-expired";
              break;
            case "coming":
              rowClass = "status-coming";
              break;
            case "valid":
              rowClass = "status-valid";
              break;
          }

          // Vessel name cell
          const nameCell = document.createElement("td");
          nameCell.className = `p-3 align-top ${rowClass} rounded-l-lg`;
          nameCell.innerHTML = `
                    <div class="font-medium">${escapeHtml(vessel.name)}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        ${vessel.db_id ? "DB Synced" : "Local Only"}
                    </div>
                `;
          row.appendChild(nameCell);

          // Certification cells
          CERTS.forEach((cert) => {
            const certData = vessel[cert] || {};
            const certCell = document.createElement("td");
            certCell.className = "p-3 align-top text-sm";

            const issue = certData.issue ? formatDate(certData.issue) : "-";
            const iDue = certData.intermediateDue
              ? formatDate(certData.intermediateDue)
              : "-";
            const expiry = certData.expiry ? formatDate(certData.expiry) : "-";

            // Get status for Intermediate
            const iStatus = getDateStatus(
              certData.intermediateDue,
              true,
              certData.intermediateCompleted
            );

            // Get status for Expiry
            const eStatus = getDateStatus(certData.expiry, false, false);

            let iLabel = iDue;
            let iClass = "text-gray-600 dark:text-gray-400";
            let iIcon = "";

            if (certData.intermediateDue) {
              if (certData.intermediateCompleted) {
                iIcon = "‚úì ";
                iClass = "text-green-600 dark:text-green-400 font-semibold";
              } else if (iStatus.status === "expired") {
                iIcon = "‚úó ";
                iClass = "text-red-600 dark:text-red-400 font-semibold";
              } else if (iStatus.status === "coming") {
                iIcon = "‚ö† ";
                iClass = "text-amber-600 dark:text-amber-400 font-semibold";
              } else {
                iClass = "text-green-600 dark:text-green-400";
              }
            }

            let eClass = "text-gray-600 dark:text-gray-400";
            let eIcon = "";

            if (eStatus.status === "expired") {
              eIcon = "‚úó ";
              eClass = "text-red-600 dark:text-red-400 font-bold";
            } else if (eStatus.status === "coming") {
              eIcon = "‚ö† ";
              eClass = "text-amber-600 dark:text-amber-400 font-semibold";
            } else if (eStatus.status === "valid") {
              eClass = "text-green-600 dark:text-green-400";
            }

            certCell.innerHTML = `
                        <div class="flex flex-col gap-1">
                            <div class="text-xs">
                                <span class="text-gray-500 dark:text-gray-400">Issue:</span>
                                <span class="ml-1">${issue}</span>
                            </div>
                            <div class="text-xs">
                                <span class="text-gray-500 dark:text-gray-400">Int:</span>
                                <span class="ml-1 ${iClass}">${iIcon}${iLabel}</span>
                            </div>
                            <div class="text-xs">
                                <span class="text-gray-500 dark:text-gray-400">Exp:</span>
                                <span class="ml-1 ${eClass}">${eIcon}${expiry}</span>
                            </div>
                        </div>
                    `;
            row.appendChild(certCell);
          });

          // Remarks cell
          // Remarks cell

          // Remarks cell
          // Remarks cell for management table (multi-line)
          const remarksCell = document.createElement("td");
          remarksCell.className = "p-3 align-top text-sm";
          const remarks = vessel.remarks || "";

          // Create a unique ID for this vessel's remarks
          const remarksId = `remarks-${vessel.id}`;

          remarksCell.innerHTML = `
  <div class="remarks-cell-multi" 
       id="${remarksId}"
       title="${escapeHtml(remarks)}">
    ${remarks || "<span class='text-gray-400'>-</span>"}
  </div>
`;

          // Add click event listener after the element is added to DOM
          setTimeout(() => {
            const remarksDiv = document.getElementById(remarksId);
            if (remarksDiv) {
              remarksDiv.addEventListener("click", () =>
                showRemarksModal(remarks)
              );
            }
          }, 0);

          row.appendChild(remarksCell);

          // Actions cell
          const actionsCell = document.createElement("td");
          actionsCell.className = "p-3 align-top rounded-r-lg";
          actionsCell.innerHTML = `
                    <div class="flex gap-2">
                        <button onclick="editVessel('${vessel.id}')" 
                                class="px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800 smooth-transition">
                            Edit
                        </button>
                        <button onclick="deleteVessel('${vessel.id}')" 
                                class="px-3 py-1 text-sm bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded hover:bg-red-200 dark:hover:bg-red-800 smooth-transition">
                            Delete
                        </button>
                    </div>
                `;
          row.appendChild(actionsCell);

          tbody.appendChild(row);
        });
      }

      function renderOverviewTable(searchText = "") {
        const tbody = document.getElementById("overviewTableBody");
        const noResults = document.getElementById("noSearchResults");

        // Sort vessels by name
        let filteredVessels = [...vessels].sort((a, b) =>
          a.name.localeCompare(b.name)
        );

        // Apply search filter if provided
        if (searchText.trim()) {
          filteredVessels = filteredVessels.filter((vessel) =>
            vessel.name.toLowerCase().includes(searchText.toLowerCase())
          );
        }

        if (filteredVessels.length === 0) {
          tbody.innerHTML = "";
          noResults.classList.remove("hidden");
          return;
        }

        noResults.classList.add("hidden");
        tbody.innerHTML = "";

        filteredVessels.forEach((vessel) => {
          const row = document.createElement("tr");
          row.className = "hover:bg-gray-50 dark:hover:bg-gray-700";

          // Vessel name
          const nameCell = document.createElement("td");
          nameCell.className =
            "p-2 font-medium sticky left-0 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700";
          nameCell.textContent = escapeHtml(vessel.name);
          row.appendChild(nameCell);

          // Certification dates
          CERTS.forEach((cert) => {
            const certData = vessel[cert] || {};

            // Issue date (always neutral - never highlighted)
            const issueCell = createOverviewDateCell(
              certData.issue,
              false,
              false,
              true // isIssueDate = true (never highlight)
            );
            row.appendChild(issueCell);

            // Intermediate date (highlight based on status)
            const intermediateCell = createOverviewDateCell(
              certData.intermediateDue,
              true,
              certData.intermediateCompleted,
              false // isIssueDate = false
            );
            row.appendChild(intermediateCell);

            // Expiry date (highlight based on status)
            const expiryCell = createOverviewDateCell(
              certData.expiry,
              false,
              false,
              false // isIssueDate = false
            );
            row.appendChild(expiryCell);
          });

          // Remarks cell for overview
          // Remarks cell for overview table (single line)
          const remarksCell = document.createElement("td");
          remarksCell.className =
            "p-2 text-sm sticky left-0 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700";
          const remarks = vessel.remarks || "";
          const overviewRemarksId = `overview-remarks-${vessel.id}`;

          remarksCell.innerHTML = `
  <div class="remarks-cell-single" 
       id="${overviewRemarksId}"
       title="${escapeHtml(remarks)}">
    ${
      remarks
        ? escapeHtml(remarks.substring(0, 20)) +
          (remarks.length > 20 ? "..." : "")
        : "<span class='text-gray-400'>-</span>"
    }
  </div>
`;

          // Add click event listener after the element is added to DOM
          setTimeout(() => {
            const remarksDiv = document.getElementById(overviewRemarksId);
            if (remarksDiv) {
              remarksDiv.addEventListener("click", () =>
                showRemarksModal(remarks)
              );
            }
          }, 0);

          row.appendChild(remarksCell);

          tbody.appendChild(row);
        });
      }

      function createOverviewDateCell(
        dateStr,
        isIntermediate = false,
        isCompleted = false,
        isIssueDate = false
      ) {
        const cell = document.createElement("td");
        cell.className = "p-2 text-center text-sm overview-date";

        if (!dateStr) {
          cell.textContent = "-";
          cell.classList.add("text-gray-400");
          return cell;
        }

        const formattedDate = formatDateForOverview(dateStr);
        const status = getDateStatus(dateStr, isIntermediate, isCompleted);

        // Issue dates are NEVER highlighted
        if (isIssueDate) {
          cell.textContent = formattedDate;
          cell.title = `Issue Date: ${formattedDate}`;
          cell.classList.add("text-gray-600", "dark:text-gray-400");
          return cell;
        }

        // Show days remaining if enabled and status is coming due
        let displayText = formattedDate;
        if (
          showDaysRemaining &&
          status.daysUntil !== null &&
          status.status === "coming"
        ) {
          displayText = `${formattedDate} (${status.daysUntil}d)`;
        }

        cell.textContent = displayText;
        cell.title = `${status.label} ‚Ä¢ ${formattedDate}`;

        // Apply color coding based on status
        switch (status.status) {
          case "valid":
            cell.classList.add("status-valid");
            if (isIntermediate && isCompleted) {
              cell.innerHTML = `‚úì ${displayText}`;
              cell.classList.add("font-semibold");
            } else {
              cell.textContent = displayText;
            }
            break;
          case "coming":
            cell.classList.add("status-coming", "font-semibold");
            cell.innerHTML = `‚ö† ${displayText}`;
            break;
          case "expired":
            cell.classList.add("status-expired", "font-bold");
            cell.innerHTML = `‚úó ${displayText}`;
            break;
          default:
            cell.textContent = displayText;
            cell.classList.add("text-gray-400");
        }

        cell.classList.add("rounded");

        return cell;
      }

      function renderChart() {
        const canvas = document.getElementById("donutChart");
        const ctx = canvas.getContext("2d");
        const isDark = document.documentElement.classList.contains("dark");

        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Calculate data
        const counts = { valid: 0, coming: 0, expired: 0 };
        vessels.forEach((vessel) => {
          const status = getVesselStatus(vessel);
          if (status.status in counts) {
            counts[status.status]++;
          }
        });

        const data = [counts.valid, counts.coming, counts.expired];
        const labels = ["Compliant", "Coming Due", "Expired"];
        const colors = isDark
          ? ["#10b981", "#f59e0b", "#ef4444"] // Dark mode colors
          : ["#34d399", "#fbbf24", "#f87171"]; // Light mode colors

        const total = data.reduce((a, b) => a + b, 0);

        // Chart dimensions
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(centerX, centerY) - 40;
        const holeRadius = radius * 0.6;

        // Reset segments for click detection
        chartSegments = [];

        if (total === 0) {
          // Draw empty state
          ctx.fillStyle = isDark ? "#6b7280" : "#9ca3af";
          ctx.font = "14px Inter";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText("No data available", centerX, centerY);
          return;
        }

        let startAngle = 0;

        // Draw segments
        data.forEach((value, index) => {
          if (value === 0) return;

          const sliceAngle = (value / total) * 2 * Math.PI;
          const endAngle = startAngle + sliceAngle;
          const midAngle = startAngle + sliceAngle / 2;

          // Draw outer segment
          ctx.beginPath();
          ctx.moveTo(
            centerX + Math.cos(startAngle) * holeRadius,
            centerY + Math.sin(startAngle) * holeRadius
          );
          ctx.arc(centerX, centerY, radius, startAngle, endAngle);
          ctx.lineTo(
            centerX + Math.cos(endAngle) * holeRadius,
            centerY + Math.sin(endAngle) * holeRadius
          );
          ctx.arc(centerX, centerY, holeRadius, endAngle, startAngle, true);
          ctx.closePath();

          ctx.fillStyle = colors[index];
          ctx.fill();

          // Store segment for click detection
          chartSegments.push({
            startAngle: startAngle,
            endAngle: endAngle,
            outerRadius: radius,
            innerRadius: holeRadius,
            color: colors[index],
            filter: ["valid", "coming", "expired"][index],
            value: value,
            percentage: Math.round((value / total) * 100),
          });

          // Draw value label in the segment
          const labelRadius = (radius + holeRadius) / 2;
          const labelX = centerX + Math.cos(midAngle) * labelRadius;
          const labelY = centerY + Math.sin(midAngle) * labelRadius;

          ctx.fillStyle = isDark ? "#f3f4f6" : "#1f2937";
          ctx.font = "bold 12px Inter";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(`${value}`, labelX, labelY);

          startAngle = endAngle;
        });

        // Draw center text
        ctx.fillStyle = isDark ? "#f3f4f6" : "#1f2937";
        ctx.font = "bold 16px Inter";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("Total", centerX, centerY - 10);
        ctx.font = "bold 24px Inter";
        ctx.fillText(total.toString(), centerX, centerY + 15);

        // Draw legend
        const legendX = 20;
        let legendY = canvas.height - 80;

        labels.forEach((label, index) => {
          if (data[index] === 0) return;

          // Color box
          ctx.fillStyle = colors[index];
          ctx.fillRect(legendX, legendY, 12, 12);

          // Label with percentage
          ctx.fillStyle = isDark ? "#f3f4f6" : "#1f2937";
          ctx.font = "12px Inter";
          ctx.textAlign = "left";
          const percentage = Math.round((data[index] / total) * 100);
          ctx.fillText(
            `${label}: ${data[index]} (${percentage}%)`,
            legendX + 20,
            legendY + 10
          );

          legendY += 20;
        });
      }

      // ============================================================================
      // EVENT HANDLERS AND INTERACTIONS
      // ============================================================================
      function setupEventListeners() {
        // Navigation
        document
          .getElementById("navManagement")
          .addEventListener("click", () => switchView("management"));
        document
          .getElementById("navOverview")
          .addEventListener("click", () => switchView("overview"));
        document
          .getElementById("navImportExport")
          .addEventListener("click", () => switchView("importExport"));

        // Form
        document
          .getElementById("vesselForm")
          .addEventListener("submit", handleFormSubmit);
        document
          .getElementById("clearForm")
          .addEventListener("click", clearForm);
        document
          .getElementById("cancelEdit")
          .addEventListener("click", cancelEdit);

        // Summary cards filtering
        document.querySelectorAll(".summary-card").forEach((card) => {
          card.addEventListener("click", function () {
            const filter = this.dataset.filter;
            if (currentFilter === filter) {
              clearFilter();
            } else {
              setFilter(filter);
            }
          });
        });

        // Clear filter button
        document
          .getElementById("clearFilter")
          .addEventListener("click", clearFilter);

        // Toggle days remaining
        document
          .getElementById("toggleDays")
          .addEventListener("click", toggleDaysRemaining);
        document
          .getElementById("toggleDaysOverview")
          .addEventListener("click", toggleDaysRemaining);

        // Chart click detection
        document
          .getElementById("donutChart")
          .addEventListener("click", handleChartClick);

        // Show hidden section button - FIXED
        document
          .getElementById("showHiddenSection")
          .addEventListener("click", () => {
            checkHiddenSectionPassword();
          });

        // Search functionality
        document
          .getElementById("searchVessels")
          .addEventListener("input", function (e) {
            searchQuery = e.target.value;
            renderOverviewTable(searchQuery);
          });

        // Import/Export functions (no password needed once section is visible)
        document
          .getElementById("csvFileInput")
          .addEventListener("change", handleFileSelect);

        document
          .getElementById("exportCSV")
          .addEventListener("click", exportCSV);

        // Changed from exportPDF to exportOverviewPDF
        document
          .getElementById("exportPDF")
          .addEventListener("click", exportOverviewPDF);

        document
          .getElementById("clearAllData")
          .addEventListener("click", clearAllData);

        // Database sync
        document
          .getElementById("syncToDatabase")
          .addEventListener("click", syncAllToDatabase);

        // Refresh button
        document
          .getElementById("refreshData")
          .addEventListener("click", async () => {
            if (isSupabaseConnected) {
              await loadFromDatabase();
            } else {
              renderAll();
              showNotification("Data refreshed", "success");
            }
          });

        // Password modal - FIXED
        document
          .getElementById("submitPassword")
          .addEventListener("click", () => {
            const password = document.getElementById("sectionPassword").value;
            if (password === SECTION_PASSWORD) {
              showHiddenSection();
              document.getElementById("passwordModal").classList.add("hidden");
              document.getElementById("sectionPassword").value = "";
            } else {
              showNotification("Incorrect password", "error");
              document.getElementById("sectionPassword").value = "";
            }
          });

        document
          .getElementById("cancelPassword")
          .addEventListener("click", () => {
            document.getElementById("passwordModal").classList.add("hidden");
            document.getElementById("sectionPassword").value = "";
          });

        document
          .getElementById("sectionPassword")
          .addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              const password = document.getElementById("sectionPassword").value;
              if (password === SECTION_PASSWORD) {
                showHiddenSection();
                document
                  .getElementById("passwordModal")
                  .classList.add("hidden");
                document.getElementById("sectionPassword").value = "";
              } else {
                showNotification("Incorrect password", "error");
                document.getElementById("sectionPassword").value = "";
              }
            }
            if (e.key === "Escape") {
              document.getElementById("passwordModal").classList.add("hidden");
              document.getElementById("sectionPassword").value = "";
            }
          });

        // Import modal
        document
          .getElementById("cancelImport")
          .addEventListener("click", cancelImport);
        document
          .getElementById("confirmImport")
          .addEventListener("click", confirmImport);
      }

      function switchView(viewName) {
        // Update active navigation
        document.querySelectorAll('[id^="nav"]').forEach((nav) => {
          nav.classList.remove(
            "active-view",
            "border-maritime-500",
            "text-maritime-600",
            "dark:text-maritime-400"
          );
        });

        const activeNav = document.getElementById(
          `nav${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`
        );
        if (activeNav) {
          activeNav.classList.add(
            "active-view",
            "border-maritime-500",
            "text-maritime-600",
            "dark:text-maritime-400"
          );
        }

        // Show selected view
        document.querySelectorAll(".view-content").forEach((view) => {
          view.classList.add("hidden");
        });

        const activeView = document.getElementById(
          `view${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`
        );
        if (activeView) {
          activeView.classList.remove("hidden");
          currentView = viewName;

          // If it's the hidden import/export view and section is not visible, hide it
          if (viewName === "importExport" && !isHiddenSectionVisible) {
            activeView.classList.add("hidden-section");
          } else if (viewName === "importExport" && isHiddenSectionVisible) {
            activeView.classList.remove("hidden-section");
          }

          // Refresh view-specific content
          if (viewName === "overview") {
            renderOverviewTable(searchQuery);
          } else if (viewName === "management") {
            renderManagementTable();
          }
        }
      }

      async function handleFormSubmit(event) {
        event.preventDefault();

        // Show loading state
        const submitButton = document.getElementById("submitButton");
        const submitText = document.getElementById("submitText");
        const submitSpinner = document.getElementById("submitSpinner");

        submitButton.disabled = true;
        submitText.textContent = "Saving...";
        submitSpinner.classList.remove("hidden");

        try {
          const vesselName = document.getElementById("vesselName").value.trim();
          const remarks = document.getElementById("remarks").value.trim();

          if (!vesselName) {
            showNotification("Vessel name is required", "error");
            return;
          }

          // Check for duplicate vessel name (case-insensitive)
          const isDuplicate = vessels.some(
            (v) =>
              v.id !== editId &&
              v.name.toLowerCase() === vesselName.toLowerCase()
          );

          if (isDuplicate && !editId) {
            if (
              !confirm(
                `Vessel '${vesselName}' already exists. Update existing vessel instead?`
              )
            ) {
              return;
            }
            // Find and edit the existing vessel
            const existingVessel = vessels.find(
              (v) => v.name.toLowerCase() === vesselName.toLowerCase()
            );
            if (existingVessel) {
              editVessel(existingVessel.id);
              return;
            }
          }

          // Prepare vessel data
          const vesselData = {
            id: editId || vesselName.toLowerCase().replace(/[^a-z0-9]/g, "-"),
            name: vesselName,
            remarks: remarks,
            createdAt: editId
              ? vessels.find((v) => v.id === editId)?.createdAt
              : new Date().toISOString(),
          };

          // Add certification data
          CERTS.forEach((cert) => {
            const issue = normalizeDate(
              document.getElementById(`${cert}-issue`).value
            );
            const expiry = normalizeDate(
              document.getElementById(`${cert}-expiry`).value
            );
            let intermediateDue = normalizeDate(
              document.getElementById(`${cert}-intermediateDue`).value
            );
            const intermediateCompleted = document.getElementById(
              `${cert}-intermediateCompleted`
            ).checked;

            // Validate required dates
            if (!issue || !expiry) {
              showNotification(
                `${CERT_SHORT[cert]} requires both issue and expiry dates`,
                "error"
              );
              throw new Error("Validation failed");
            }

            // Auto-calculate intermediate if not provided
            if (!intermediateDue && issue && expiry) {
              intermediateDue = calculateMidpoint(issue, expiry);
            }

            vesselData[cert] = {
              issue: issue,
              expiry: expiry,
              intermediateDue: intermediateDue,
              intermediateCompleted: intermediateCompleted,
            };
          });

          // Save to database if connected
          if (isSupabaseConnected) {
            // If editing, preserve database ID
            if (editId && editDbId) {
              vesselData.db_id = editDbId;
            } else if (editId) {
              // Find existing vessel's db_id
              const existingVessel = vessels.find((v) => v.id === editId);
              if (existingVessel?.db_id) {
                vesselData.db_id = existingVessel.db_id;
              }
            }

            const dbResult = await saveVesselToDatabase(vesselData);
            if (dbResult) {
              vesselData.db_id = dbResult.id;
              vesselData.updatedAt = dbResult.updated_at;
            } else if (!dbResult && isSupabaseConnected) {
              // Database save failed (likely duplicate)
              return;
            }
          }

          // Update or add vessel locally
          if (editId) {
            const index = vessels.findIndex((v) => v.id === editId);
            if (index !== -1) {
              vessels[index] = vesselData;
              showNotification(`Updated vessel: ${vesselName}`, "success");
            }
          } else {
            // Check again for duplicate before adding (race condition)
            const existingIndex = vessels.findIndex(
              (v) => v.name.toLowerCase() === vesselName.toLowerCase()
            );

            if (existingIndex !== -1) {
              // Update existing vessel
              vessels[existingIndex] = vesselData;
              showNotification(`Updated vessel: ${vesselName}`, "success");
            } else {
              // Add new vessel
              vessels.push(vesselData);
              showNotification(`Added vessel: ${vesselName}`, "success");
            }
          }

          // Save and refresh
          saveData();
          clearForm();
          renderAll();
        } catch (error) {
          console.error("Error saving vessel:", error);
          showNotification("Error saving vessel", "error");
        } finally {
          // Reset button state
          submitButton.disabled = false;
          submitText.textContent = editId ? "Update Vessel" : "Save Vessel";
          submitSpinner.classList.add("hidden");
        }
      }

      function editVessel(vesselId) {
        const vessel = vessels.find((v) => v.id === vesselId);
        if (!vessel) return;

        editId = vesselId;
        editDbId = vessel.db_id || null;
        document.getElementById(
          "formTitle"
        ).textContent = `‚úèÔ∏è Edit ${vessel.name}`;
        document.getElementById("vesselName").value = vessel.name;
        document.getElementById("remarks").value = vessel.remarks || "";
        document.getElementById("cancelEdit").classList.remove("hidden");

        // Update submit button text
        document.getElementById("submitText").textContent = "Update Vessel";

        // Fill certification data
        CERTS.forEach((cert) => {
          const certData = vessel[cert] || {};
          document.getElementById(`${cert}-issue`).value = certData.issue || "";
          document.getElementById(`${cert}-expiry`).value =
            certData.expiry || "";
          document.getElementById(`${cert}-intermediateDue`).value =
            certData.intermediateDue || "";
          document.getElementById(`${cert}-intermediateCompleted`).checked =
            certData.intermediateCompleted || false;

          // Trigger auto-calculation if intermediate is empty
          if (!certData.intermediateDue && certData.issue && certData.expiry) {
            const midpoint = calculateMidpoint(certData.issue, certData.expiry);
            if (midpoint) {
              document.getElementById(`${cert}-intermediateDue`).value =
                midpoint;
            }
          }
        });

        // Switch to management view and scroll to form
        switchView("management");
        document
          .getElementById("vesselForm")
          .scrollIntoView({ behavior: "smooth" });
      }

      async function deleteVessel(vesselId) {
        const vessel = vessels.find((v) => v.id === vesselId);
        if (!vessel) return;

        if (
          !confirm(
            `Are you sure you want to delete vessel '${vessel.name}'? This action cannot be undone.`
          )
        ) {
          return;
        }

        try {
          // Delete from database if connected
          if (isSupabaseConnected && vessel.name) {
            const success = await deleteVesselFromDatabase(vessel.name);
            if (!success) {
              showNotification("Failed to delete from database", "error");
              return;
            }
          }

          // Remove from local array
          const vesselIndex = vessels.findIndex((v) => v.id === vesselId);
          if (vesselIndex !== -1) {
            vessels.splice(vesselIndex, 1);
            saveData();
            renderAll();
            showNotification(`Deleted vessel: ${vessel.name}`, "warning");
          }
        } catch (error) {
          console.error("Delete error:", error);
          showNotification("Error deleting vessel", "error");
        }
      }

      function clearForm() {
        document.getElementById("vesselForm").reset();
        editId = null;
        editDbId = null;
        document.getElementById("formTitle").textContent = "‚ûï Add New Vessel";
        document.getElementById("cancelEdit").classList.add("hidden");
        document.getElementById("submitText").textContent = "Save Vessel";
      }

      function cancelEdit() {
        clearForm();
      }

      function setFilter(filter) {
        currentFilter = filter;
        document.querySelectorAll(".summary-card").forEach((card) => {
          if (card.dataset.filter === filter) {
            card.classList.add("ring-2", "ring-maritime-500");
          } else {
            card.classList.remove("ring-2", "ring-maritime-500");
          }
        });

        renderManagementTable();
      }

      function clearFilter() {
        currentFilter = null;
        document.querySelectorAll(".summary-card").forEach((card) => {
          card.classList.remove("ring-2", "ring-maritime-500");
        });

        renderManagementTable();
      }

      function toggleDaysRemaining() {
        showDaysRemaining = !showDaysRemaining;

        const buttonText = showDaysRemaining
          ? "Hide Days Remaining"
          : "Show Days Remaining";
        document.getElementById("toggleDays").textContent = buttonText;
        document.getElementById("toggleDaysOverview").textContent = buttonText;

        if (currentView === "overview") {
          renderOverviewTable(searchQuery);
        }
      }

      function handleChartClick(event) {
        const canvas = event.target;
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const dx = x - centerX;
        const dy = y - centerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx);

        // Normalize angle to 0-2œÄ
        const normalizedAngle = angle < 0 ? angle + 2 * Math.PI : angle;

        // Check if click is within any segment
        for (const segment of chartSegments) {
          if (
            distance >= segment.innerRadius &&
            distance <= segment.outerRadius &&
            normalizedAngle >= segment.startAngle &&
            normalizedAngle <= segment.endAngle
          ) {
            if (currentFilter === segment.filter) {
              clearFilter();
            } else {
              setFilter(segment.filter);
            }
            return;
          }
        }
      }

      // ============================================================================
      // IMPORT/EXPORT FUNCTIONS
      // ============================================================================
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.name.toLowerCase().endsWith(".csv")) {
          alert("Please select a CSV file");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          processCSV(e.target.result);
        };
        reader.onerror = function (e) {
          console.error("File reading error:", e);
          showNotification("Error reading file. Please try again.", "error");
        };
        reader.readAsText(file, "UTF-8");
      }

      function processCSV(csvText) {
        const modal = document.getElementById("importModal");
        const status = document.getElementById("importStatus");
        const progress = document.getElementById("importProgress");
        const progressBar = document.getElementById("importProgressBar");
        const results = document.getElementById("importResults");
        const added = document.getElementById("importAdded");
        const updated = document.getElementById("importUpdated");
        const skipped = document.getElementById("importSkipped");
        const confirmBtn = document.getElementById("confirmImport");

        // Reset modal
        modal.classList.remove("hidden");
        results.classList.add("hidden");
        confirmBtn.classList.add("hidden");
        status.textContent = "Parsing CSV file...";
        progress.textContent = "0/0";
        progressBar.style.width = "0%";

        // Use setTimeout to prevent blocking the UI
        setTimeout(() => {
          try {
            const lines = csvText.trim().split("\n");
            if (lines.length < 2) {
              throw new Error("CSV file is empty or has no data rows");
            }

            // Parse headers
            const headers = lines[0]
              .toLowerCase()
              .split(",")
              .map((h) => h.trim());

            // Check for required name column
            if (!headers.includes("name")) {
              throw new Error('CSV must contain a "name" column');
            }

            // Process rows
            const newVessels = [];

            for (let i = 1; i < lines.length; i++) {
              // Update progress
              status.textContent = `Processing row ${i} of ${lines.length - 1}`;
              progress.textContent = `${i}/${lines.length - 1}`;
              progressBar.style.width = `${(i / (lines.length - 1)) * 100}%`;

              const line = lines[i];
              if (!line.trim()) continue;

              // Simple CSV parsing (no quotes handling for now)
              const values = line.split(",").map((v) => v.trim());
              const rowData = {};

              headers.forEach((header, index) => {
                if (index < values.length) {
                  rowData[header] = values[index];
                }
              });

              // Validate required fields
              if (!rowData.name) {
                console.warn(`Row ${i + 1}: Missing vessel name`);
                continue;
              }

              // Create vessel object
              const vessel = {
                id: rowData.name.toLowerCase().replace(/[^a-z0-9]/g, "-"),
                name: rowData.name.trim(),
                remarks: rowData.remarks || rowData.notes || "",
                createdAt: new Date().toISOString(),
              };

              // Process each certification
              CERTS.forEach((cert) => {
                const certData = {};

                // Get dates with various possible column names
                const dateFields = [
                  `${cert}_issue`,
                  `${cert}_expiry`,
                  `${cert}_intermediatedue`,
                  `${cert}_intermediate_due`,
                ];

                // Find issue date
                let issueDate = null;
                for (const field of dateFields.filter((f) =>
                  f.includes("issue")
                )) {
                  if (rowData[field]) {
                    issueDate = normalizeDate(rowData[field]);
                    if (issueDate) break;
                  }
                }

                // Find expiry date
                let expiryDate = null;
                for (const field of dateFields.filter((f) =>
                  f.includes("expiry")
                )) {
                  if (rowData[field]) {
                    expiryDate = normalizeDate(rowData[field]);
                    if (expiryDate) break;
                  }
                }

                // Find intermediate due date
                let intermediateDue = null;
                for (const field of dateFields.filter((f) =>
                  f.includes("intermediate")
                )) {
                  if (rowData[field]) {
                    intermediateDue = normalizeDate(rowData[field]);
                    if (intermediateDue) break;
                  }
                }

                // Get intermediate completed status
                let intermediateCompleted = false;
                const completedFields = [
                  `${cert}_intermediatecompleted`,
                  `${cert}_intermediate_completed`,
                ];

                for (const field of completedFields) {
                  if (rowData[field] !== undefined) {
                    const val = rowData[field].toString().toLowerCase().trim();
                    intermediateCompleted = [
                      "true",
                      "yes",
                      "y",
                      "1",
                      "completed",
                    ].includes(val);
                    if (intermediateCompleted) break;
                  }
                }

                // Calculate intermediate if not provided but issue and expiry exist
                if (!intermediateDue && issueDate && expiryDate) {
                  intermediateDue = calculateMidpoint(issueDate, expiryDate);
                }

                certData.issue = issueDate;
                certData.expiry = expiryDate;
                certData.intermediateDue = intermediateDue;
                certData.intermediateCompleted = intermediateCompleted;

                vessel[cert] = certData;
              });

              newVessels.push(vessel);
            }

            if (newVessels.length === 0) {
              throw new Error("No valid vessels found in CSV file");
            }

            // Show results
            added.textContent = newVessels.length;
            updated.textContent = 0;
            skipped.textContent = 0;

            results.classList.remove("hidden");
            confirmBtn.classList.remove("hidden");

            // Store imported data temporarily
            window.tempImportedVessels = newVessels;

            status.textContent = "Ready to import";
          } catch (error) {
            status.textContent = `Error: ${error.message}`;
            setTimeout(() => {
              modal.classList.add("hidden");
              showNotification(`Import failed: ${error.message}`, "error");
            }, 2000);
          }
        }, 100);
      }

      async function confirmImport() {
        if (!window.tempImportedVessels) return;

        const modal = document.getElementById("importModal");
        const status = document.getElementById("importStatus");
        const progress = document.getElementById("importProgress");
        const progressBar = document.getElementById("importProgressBar");

        status.textContent = "Importing vessels...";
        progress.textContent = "0/0";
        progressBar.style.width = "0%";

        // Check admin access for database import
        if (isSupabaseConnected) {
          const result = await batchImportToDatabase(
            window.tempImportedVessels
          );
          modal.classList.add("hidden");
          if (!result.success) {
            showNotification(
              `Import failed: ${result.errors.join(", ")}`,
              "error"
            );
          }
        } else {
          // Local import only
          const vesselMap = new Map();
          let added = 0;
          let updated = 0;

          // Add existing vessels to map
          vessels.forEach((vessel) => {
            vesselMap.set(vessel.name.toLowerCase(), vessel);
          });

          // Process imported vessels
          window.tempImportedVessels.forEach((importedVessel, index) => {
            // Update progress
            progress.textContent = `${index + 1}/${
              window.tempImportedVessels.length
            }`;
            progressBar.style.width = `${
              ((index + 1) / window.tempImportedVessels.length) * 100
            }%`;

            const key = importedVessel.name.toLowerCase();
            if (vesselMap.has(key)) {
              // Update existing vessel
              const existing = vesselMap.get(key);
              importedVessel.id = existing.id;
              importedVessel.createdAt = existing.createdAt;
              importedVessel.db_id = existing.db_id;
              vesselMap.set(key, importedVessel);
              updated++;
            } else {
              // Add new vessel
              vesselMap.set(key, importedVessel);
              added++;
            }
          });

          // Update vessels array
          vessels = Array.from(vesselMap.values());
          saveData();

          modal.classList.add("hidden");
          showNotification(
            `Imported ${added} new vessels, updated ${updated} existing vessels`,
            "success"
          );
        }

        // Refresh
        renderAll();

        // Clear temp data
        delete window.tempImportedVessels;

        // Clear file input
        document.getElementById("csvFileInput").value = "";
      }

      function cancelImport() {
        document.getElementById("importModal").classList.add("hidden");
        delete window.tempImportedVessels;
        document.getElementById("csvFileInput").value = "";
      }

      function exportCSV() {
        if (vessels.length === 0) {
          alert("No vessels to export");
          return;
        }

        // Prepare CSV headers
        const headers = ["name", "remarks"];
        CERTS.forEach((cert) => {
          headers.push(
            `${cert}_issue`,
            `${cert}_expiry`,
            `${cert}_intermediateDue`,
            `${cert}_intermediateCompleted`
          );
        });

        // Prepare rows
        const rows = vessels.map((vessel) => {
          const row = [vessel.name, vessel.remarks || ""];

          CERTS.forEach((cert) => {
            const certData = vessel[cert] || {};
            row.push(
              certData.issue || "",
              certData.expiry || "",
              certData.intermediateDue || "",
              certData.intermediateCompleted ? "true" : "false"
            );
          });

          return row;
        });

        // Create CSV content
        let csvContent = headers.join(",") + "\n";
        rows.forEach((row) => {
          const escapedRow = row.map((field) => {
            if (
              typeof field === "string" &&
              (field.includes(",") ||
                field.includes('"') ||
                field.includes("\n"))
            ) {
              return `"${field.replace(/"/g, '""')}"`;
            }
            return field;
          });
          csvContent += escapedRow.join(",") + "\n";
        });

        // Create and trigger download
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `vessel_compliance_export_${
            new Date().toISOString().split("T")[0]
          }.csv`
        );
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showNotification(
          `Exported ${vessels.length} vessels to CSV`,
          "success"
        );
      }

      function exportOverviewPDF() {
        if (vessels.length === 0) {
          alert("No vessels to export");
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("landscape");
        const dateStr = new Date().toLocaleDateString();

        // Title
        doc.setFontSize(20);
        doc.text("Compliance Overview Report", 14, 22);
        doc.setFontSize(11);
        doc.text(`Generated: ${dateStr}`, 14, 30);
        doc.text(`Total Vessels: ${vessels.length}`, 14, 38);

        // Calculate summary statistics
        const counts = { valid: 0, coming: 0, expired: 0 };
        vessels.forEach((vessel) => {
          const status = getVesselStatus(vessel);
          if (status.status in counts) {
            counts[status.status]++;
          }
        });

        // Add summary section
        doc.setFontSize(12);
        doc.text("Summary:", 14, 50);
        doc.setFontSize(10);
        doc.setTextColor(0, 128, 0);
        doc.text(`‚úì Fully Compliant: ${counts.valid}`, 14, 58);
        doc.setTextColor(255, 165, 0);
        doc.text(`‚ö† Coming Due (‚â§183 days): ${counts.coming}`, 14, 65);
        doc.setTextColor(255, 0, 0);
        doc.text(`‚úó Expired/Overdue: ${counts.expired}`, 14, 72);
        doc.setTextColor(0, 0, 0);

        // Prepare detailed table data
        const tableData = vessels.map((vessel) => {
          const row = [vessel.name];

          CERTS.forEach((cert) => {
            const certData = vessel[cert] || {};

            // Issue date (never colored)
            row.push(
              certData.issue ? formatDateForOverview(certData.issue) : "N/A"
            );

            // Intermediate date
            const intDate = certData.intermediateDue
              ? formatDateForOverview(certData.intermediateDue)
              : "N/A";
            const intStatus = certData.intermediateCompleted ? "‚úì " : "";
            row.push(`${intStatus}${intDate}`);

            // Expiry date
            row.push(
              certData.expiry ? formatDateForOverview(certData.expiry) : "N/A"
            );
          });

          // Add remarks
          const remarks = vessel.remarks || "";
          row.push(
            remarks.substring(0, 20) + (remarks.length > 20 ? "..." : "")
          );

          return row;
        });

        // Detailed headers
        const headers = [
          "Vessel Name",
          "SMC Issue",
          "SMC Int",
          "SMC Exp",
          "ISPS Issue",
          "ISPS Int",
          "ISPS Exp",
          "MLC Issue",
          "MLC Int",
          "MLC Exp",
          "Remarks",
        ];

        // Generate table with color coding
        doc.autoTable({
          head: [headers],
          body: tableData,
          startY: 80,
          theme: "grid",
          styles: {
            fontSize: 8,
            cellPadding: 2,
            overflow: "linebreak",
            halign: "center",
          },
          headStyles: {
            fillColor: [59, 130, 246],
            textColor: 255,
            fontSize: 9,
            fontStyle: "bold",
          },
          columnStyles: {
            0: { cellWidth: 25, halign: "left" }, // Vessel Name
            1: { cellWidth: 15 }, // SMC Issue
            2: { cellWidth: 15 }, // SMC Int
            3: { cellWidth: 15 }, // SMC Exp
            4: { cellWidth: 15 }, // ISPS Issue
            5: { cellWidth: 15 }, // ISPS Int
            6: { cellWidth: 15 }, // ISPS Exp
            7: { cellWidth: 15 }, // MLC Issue
            8: { cellWidth: 15 }, // MLC Int
            9: { cellWidth: 15 }, // MLC Exp
            10: { cellWidth: 25, halign: "left" }, // Remarks
          },
          willDrawCell: function (data) {
            // Skip header row
            if (data.section === "head") return;

            const vesselIndex = data.row.index;
            const vessel = vessels[vesselIndex];

            if (vessel) {
              // Check if this is an intermediate date column (columns 2, 5, 8)
              const intermediateCols = [2, 5, 8];
              if (intermediateCols.includes(data.column.index)) {
                const certIndex = Math.floor((data.column.index - 1) / 3);
                const cert = CERTS[certIndex];
                const certData = vessel[cert] || {};

                if (certData.intermediateDue) {
                  const status = getDateStatus(
                    certData.intermediateDue,
                    true,
                    certData.intermediateCompleted
                  );

                  // Apply color coding
                  if (certData.intermediateCompleted) {
                    doc.setFillColor(220, 255, 220); // Light green
                    doc.rect(
                      data.cell.x,
                      data.cell.y,
                      data.cell.width,
                      data.cell.height,
                      "F"
                    );
                    doc.setTextColor(0, 128, 0);
                  } else if (status.status === "expired") {
                    doc.setFillColor(255, 220, 220); // Light red
                    doc.rect(
                      data.cell.x,
                      data.cell.y,
                      data.cell.width,
                      data.cell.height,
                      "F"
                    );
                    doc.setTextColor(255, 0, 0);
                  } else if (status.status === "coming") {
                    doc.setFillColor(255, 248, 220); // Light yellow
                    doc.rect(
                      data.cell.x,
                      data.cell.y,
                      data.cell.width,
                      data.cell.height,
                      "F"
                    );
                    doc.setTextColor(255, 165, 0);
                  }
                }
              }

              // Check if this is an expiry date column (columns 3, 6, 9)
              const expiryCols = [3, 6, 9];
              if (expiryCols.includes(data.column.index)) {
                const certIndex = Math.floor((data.column.index - 1) / 3);
                const cert = CERTS[certIndex];
                const certData = vessel[cert] || {};

                if (certData.expiry) {
                  const status = getDateStatus(certData.expiry, false, false);

                  // Apply color coding
                  if (status.status === "expired") {
                    doc.setFillColor(255, 220, 220); // Light red
                    doc.rect(
                      data.cell.x,
                      data.cell.y,
                      data.cell.width,
                      data.cell.height,
                      "F"
                    );
                    doc.setTextColor(255, 0, 0);
                  } else if (status.status === "coming") {
                    doc.setFillColor(255, 248, 220); // Light yellow
                    doc.rect(
                      data.cell.x,
                      data.cell.y,
                      data.cell.width,
                      data.cell.height,
                      "F"
                    );
                    doc.setTextColor(255, 165, 0);
                  }
                }
              }
            }
          },
          didDrawCell: function (data) {
            // Reset text color after drawing each cell
            doc.setTextColor(0, 0, 0);
          },
          alternateRowStyles: {
            fillColor: [240, 240, 240],
          },
        });

        // Save PDF
        doc.save(
          `compliance_overview_${new Date().toISOString().split("T")[0]}.pdf`
        );

        showNotification(
          "Compliance overview PDF generated successfully",
          "success"
        );
      }

      async function syncAllToDatabase() {
        if (!isSupabaseConnected) {
          showNotification("Database not configured", "error");
          return;
        }

        try {
          showNotification("Syncing to database...", "info");

          let successCount = 0;
          let failCount = 0;

          for (const vessel of vessels) {
            try {
              const result = await saveVesselToDatabase(vessel);
              if (result) {
                // Update local vessel with database ID if new
                if (!vessel.db_id) {
                  vessel.db_id = result.id;
                }
                successCount++;
              } else {
                failCount++;
              }
            } catch (error) {
              console.error(`Failed to sync vessel ${vessel.name}:`, error);
              failCount++;
            }
          }

          saveData(); // Save updated local data

          if (failCount === 0) {
            showNotification(
              `Successfully synced ${successCount} vessels to database`,
              "success"
            );
          } else {
            showNotification(
              `Synced ${successCount} vessels, failed: ${failCount}`,
              "warning"
            );
          }
        } catch (error) {
          console.error("Sync error:", error);
          showNotification("Sync failed", "error");
        }
      }

      function clearAllData() {
        if (vessels.length === 0) {
          alert("No data to clear");
          return;
        }

        if (
          !confirm(
            `Are you sure you want to delete ALL ${vessels.length} vessel records? This action cannot be undone.`
          )
        ) {
          return;
        }

        // Optionally delete from database
        if (isSupabaseConnected && confirm("Also delete from database?")) {
          vessels.forEach(async (vessel) => {
            if (vessel.db_id) {
              await deleteVesselFromDatabase(vessel.name);
            }
          });
        }

        vessels = [];
        saveData();
        clearForm();
        clearFilter();
        renderAll();

        showNotification("All vessel data has been cleared", "warning");
      }

      // ============================================================================
      // UTILITY FUNCTIONS
      // ============================================================================
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function updateLastUpdated() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
        const dateStr = now.toLocaleDateString();
        document.getElementById(
          "lastUpdated"
        ).textContent = `${dateStr} ${timeStr}`;
      }

      function updateCounts() {
        document.getElementById("totalVessels").textContent = vessels.length;
        document.getElementById("filteredCount").textContent = currentFilter
          ? vessels.filter((v) => getVesselStatus(v).status === currentFilter)
              .length
          : vessels.length;
      }

      function showNotification(message, type = "info") {
        const container = document.getElementById("notificationContainer");

        // Create notification element
        const notification = document.createElement("div");
        notification.className = `px-6 py-3 rounded-lg shadow-lg smooth-transition transform translate-x-full opacity-0 ${
          type === "success"
            ? "bg-green-500 text-white"
            : type === "warning"
            ? "bg-amber-500 text-white"
            : type === "error"
            ? "bg-red-500 text-white"
            : "bg-blue-500 text-white"
        }`;
        notification.textContent = message;

        // Add to container
        container.appendChild(notification);

        // Animate in
        setTimeout(() => {
          notification.classList.remove("translate-x-full", "opacity-0");
          notification.classList.add("translate-x-0", "opacity-100");
        }, 10);

        // Remove after 3 seconds
        setTimeout(() => {
          notification.classList.remove("translate-x-0", "opacity-100");
          notification.classList.add("translate-x-full", "opacity-0");
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }

      function escapeForAttribute(text) {
        if (!text) return "''";

        // Escape quotes and special characters
        const escaped = text
          .replace(/\\/g, "\\\\") // Escape backslashes
          .replace(/'/g, "\\'") // Escape single quotes
          .replace(/"/g, '\\"') // Escape double quotes
          .replace(/\n/g, "\\n") // Escape newlines
          .replace(/\r/g, "\\r") // Escape carriage returns
          .replace(/\t/g, "\\t"); // Escape tabs

        return `'${escaped}'`;
      }

      // Make functions available globally for onclick handlers
      window.editVessel = editVessel;
      window.deleteVessel = deleteVessel;
      window.showRemarksModal = showRemarksModal;
      window.escapeForAttribute = escapeForAttribute;
      // ============================================================================
      // REMARKS MODAL FUNCTIONS
      // ============================================================================
      function setupRemarksModal() {
        const modal = document.getElementById("remarksModal");
        const closeBtn = document.getElementById("closeRemarksModal");
        const closeBtnBottom = document.getElementById(
          "closeRemarksModalBottom"
        );
        const copyBtn = document.getElementById("copyRemarks");
        const remarksContent = document.getElementById("remarksContent");
        const charCount = document.getElementById("remarksCharCount");

        // Close modal when clicking X or Close button
        closeBtn.addEventListener("click", () => {
          modal.classList.add("hidden");
        });

        closeBtnBottom.addEventListener("click", () => {
          modal.classList.add("hidden");
        });

        // Close modal when clicking outside
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.classList.add("hidden");
          }
        });

        // Close with Escape key
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && !modal.classList.contains("hidden")) {
            modal.classList.add("hidden");
          }
        });

        // Copy remarks to clipboard
        copyBtn.addEventListener("click", async () => {
          try {
            const text = remarksContent.textContent;
            await navigator.clipboard.writeText(text);

            // Show feedback
            const originalText = copyBtn.textContent;
            copyBtn.textContent = "‚úì Copied!";
            copyBtn.classList.add("bg-green-600", "hover:bg-green-700");
            copyBtn.classList.remove(
              "bg-maritime-600",
              "hover:bg-maritime-700"
            );

            setTimeout(() => {
              copyBtn.textContent = originalText;
              copyBtn.classList.remove("bg-green-600", "hover:bg-green-700");
              copyBtn.classList.add("bg-maritime-600", "hover:bg-maritime-700");
            }, 2000);

            showNotification("Remarks copied to clipboard", "success");
          } catch (error) {
            console.error("Failed to copy:", error);
            showNotification("Failed to copy remarks", "error");
          }
        });

        // Update character count when modal opens
        const updateCharCount = () => {
          const text = remarksContent.textContent;
          const charCountValue = text.length;
          charCount.textContent = `${charCountValue} character${
            charCountValue !== 1 ? "s" : ""
          }`;

          // Style based on length
          if (charCountValue > 1000) {
            charCount.classList.add("text-red-500");
            charCount.classList.remove("text-gray-500");
          } else if (charCountValue > 500) {
            charCount.classList.add("text-amber-500");
            charCount.classList.remove("text-gray-500");
          } else {
            charCount.classList.remove("text-red-500", "text-amber-500");
            charCount.classList.add("text-gray-500");
          }
        };

        // Observe changes to remarks content
        const observer = new MutationObserver(updateCharCount);
        observer.observe(remarksContent, {
          childList: true,
          characterData: true,
          subtree: true,
        });
      }

      function showRemarksModal(remarks) {
        const modal = document.getElementById("remarksModal");
        const remarksContent = document.getElementById("remarksContent");
        const charCount = document.getElementById("remarksCharCount");

        // Set the content
        remarksContent.textContent = remarks || "No remarks available";

        // Update character count
        const charCountValue = remarks.length;
        charCount.textContent = `${charCountValue} character${
          charCountValue !== 1 ? "s" : ""
        }`;

        // Style based on length
        charCount.className = "text-sm ";
        if (charCountValue > 1000) {
          charCount.classList.add("text-red-500", "dark:text-red-400");
        } else if (charCountValue > 500) {
          charCount.classList.add("text-amber-500", "dark:text-amber-400");
        } else {
          charCount.classList.add("text-gray-500", "dark:text-gray-400");
        }

        // Show modal
        modal.classList.remove("hidden");

        // Focus for accessibility
        setTimeout(() => {
          document.getElementById("closeRemarksModal").focus();
        }, 100);
      }
    </script>
    <!-- Remarks Modal -->
    <div
      id="remarksModal"
      class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop"
    >
      <div class="relative max-w-2xl w-full mx-auto">
        <div
          class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-h-[80vh] flex flex-col"
        >
          <div
            class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700"
          >
            <h3 class="text-lg font-semibold">Remarks</h3>
            <button
              id="closeRemarksModal"
              class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 text-xl"
            >
              ‚úï
            </button>
          </div>
          <div class="p-6 overflow-y-auto flex-grow">
            <div
              id="remarksContent"
              class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap"
            ></div>
          </div>
          <div
            class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center"
          >
            <span
              class="text-sm text-gray-500 dark:text-gray-400"
              id="remarksCharCount"
              >0 characters</span
            >
            <div class="flex gap-2">
              <button
                id="copyRemarks"
                class="px-4 py-2 bg-maritime-600 text-white rounded-lg hover:bg-maritime-700 smooth-transition text-sm"
              >
                üìã Copy
              </button>
              <button
                id="closeRemarksModalBottom"
                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 smooth-transition text-sm"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

