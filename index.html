<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vessel Compliance Dashboard</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- D3.js CDN -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    /* small custom styles for pills and clickable bars */
    .pill { @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium; }
    .cursor-click { cursor: pointer; }
    /* chart container sizing */
    #chart { width: 320px; height: 180px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 p-6">
  <div class="max-w-6xl mx-auto">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold">Vessel Compliance — Data Input & Dashboard</h1>
      <p class="text-sm text-slate-600">Add vessels, track SMC / ISPS / MLC certificates, view status, filter & export CSV.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Form (left) -->
      <section class="lg:col-span-1 bg-white p-4 rounded-lg shadow">
        <h2 class="text-lg font-semibold mb-3" id="formTitle">Add Vessel</h2>
        <form id="vesselForm" class="space-y-3">
          <div>
            <label class="block text-sm font-medium">Vessel Name <span class="text-red-500">*</span></label>
            <input id="vesselName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
          </div>

          <!-- function to render certificate section -->
          <div id="certSections" class="space-y-3"></div>

          <div class="flex items-center gap-2">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
            <button id="cancelEdit" type="button" class="hidden bg-gray-200 px-3 py-2 rounded">Cancel Edit</button>
            <button id="clearForm" type="button" class="ml-auto text-sm text-slate-600 hover:underline">Clear</button>
          </div>
          <p class="text-xs text-slate-500">Expiry Date is required for each certificate.</p>
        </form>
      </section>

      <!-- Summary cards and chart (top right) -->
      <section class="lg:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="col-span-2 bg-white p-4 rounded-lg shadow">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Compliance Summary</h3>
            <div class="flex gap-2">
              <button id="exportCsv" class="text-sm bg-emerald-600 text-white px-3 py-1 rounded hover:bg-emerald-700">Export CSV</button>
              <button id="clearAll" class="text-sm bg-red-50 text-red-700 px-3 py-1 rounded hover:bg-red-100">Delete All</button>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3 mb-4">
            <div id="card-valid" class="cursor-click p-3 rounded-lg border bg-green-50 flex flex-col items-center">
              <div class="text-slate-700 text-sm">Fully Compliant</div>
              <div id="countValid" class="text-2xl font-bold text-green-700">0</div>
            </div>
            <div id="card-coming" class="cursor-click p-3 rounded-lg border bg-amber-50 flex flex-col items-center">
              <div class="text-slate-700 text-sm">Coming Due (≤90d)</div>
              <div id="countComing" class="text-2xl font-bold text-amber-700">0</div>
            </div>
            <div id="card-expired" class="cursor-click p-3 rounded-lg border bg-red-50 flex flex-col items-center">
              <div class="text-slate-700 text-sm">Expired / Overdue</div>
              <div id="countExpired" class="text-2xl font-bold text-red-700">0</div>
            </div>
          </div>

          <div class="flex items-center gap-6">
            <div id="chart" class="mr-6"></div>
            <div class="text-sm text-slate-600">
              Click a bar or summary card to filter the vessel table below.<br/>
              <button id="clearFilter" class="mt-3 bg-slate-100 px-3 py-1 rounded text-sm">Clear filter</button>
            </div>
          </div>

        </div>

        <!-- Table container -->
        <div class="col-span-1 md:col-span-1 bg-white p-4 rounded-lg shadow md:col-span-3 lg:col-span-2">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Vessels</h3>
            <div class="text-sm text-slate-500">Total: <span id="totalCount">0</span></div>
          </div>

          <div class="overflow-x-auto">
            <table id="vesselTable" class="min-w-full divide-y divide-slate-200">
              <thead class="bg-slate-50">
                <tr>
                  <th class="p-2 text-left text-xs font-medium text-slate-600">Vessel</th>
                  <th class="p-2 text-left text-xs font-medium text-slate-600">SMC</th>
                  <th class="p-2 text-left text-xs font-medium text-slate-600">ISPS</th>
                  <th class="p-2 text-left text-xs font-medium text-slate-600">MLC</th>
                  <th class="p-2 text-left text-xs font-medium text-slate-600">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody" class="bg-white divide-y divide-slate-100"></tbody>
            </table>
          </div>
        </div>

      </section>
    </div>
  </div>

<script>
/*
Data model per vessel:
{
  id: string,
  name: string,
  smc: { issue: 'YYYY-MM-DD'|'', intermediateDue:'', expiry:'YYYY-MM-DD', intermediateCompleted: boolean },
  isps: {...},
  mlc: {...},
  createdAt: timestamp
}
*/
const CERTS = ['smc','isps','mlc'];
const CERT_LABEL = { smc: 'SMC', isps: 'ISPS', mlc: 'MLC' };
const STORAGE_KEY = 'vessels_compliance_v1';
let vessels = [];
let editId = null;
let currentFilter = null; // 'valid'|'coming'|'expired'|null

// ---------- Utilities ----------
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,8);
const today = () => {
  const d = new Date();
  d.setHours(0,0,0,0);
  return d;
};
function parseDateISO(s){ if(!s) return null; const d = new Date(s); d.setHours(0,0,0,0); return isNaN(d) ? null : d; }
function daysBetween(d1, d2){ // d1,d2 Date objects normalized
  const ms = d2 - d1;
  return Math.ceil(ms / (1000*60*60*24));
}
function formatDate(s){
  if(!s) return '-';
  const d = new Date(s);
  if(isNaN(d)) return s;
  return d.toISOString().slice(0,10);
}

// compute vessel status overall: 'expired','coming','valid'
function classifyVessel(v){
  // If any certificate expiry passed -> expired
  // If any intermediate due passed & not completed -> expired
  // Else if any expiry or intermediate due within next 90 days -> coming
  // Else valid
  const now = today();
  const horizon = new Date(now.getTime() + 90*24*60*60*1000);
  let anyComing = false;
  for(const c of CERTS){
    const cert = v[c] || {};
    const expiry = parseDateISO(cert.expiry);
    const iDue = parseDateISO(cert.intermediateDue);
    const iCompleted = !!cert.intermediateCompleted;

    if(expiry && expiry < now) return 'expired';
    if(iDue && !iCompleted && iDue < now) return 'expired';

    if(expiry && expiry <= horizon) anyComing = true;
    if(iDue && !iCompleted && iDue <= horizon) anyComing = true;
  }
  return anyComing ? 'coming' : 'valid';
}

// per certificate status pill: returns {label, colorClass}
function certStatus(cert){
  // cert: {issue, intermediateDue, expiry, intermediateCompleted}
  const now = today();
  const horizon = new Date(now.getTime() + 90*24*60*60*1000);
  const expiry = parseDateISO(cert.expiry);
  const iDue = parseDateISO(cert.intermediateDue);
  if(cert.intermediateCompleted){
    return {label: 'Intermediate Done', color: 'bg-sky-100 text-sky-800', title: 'Intermediate completed'};
  }
  if(iDue && iDue < now){
    return {label: 'Intermediate Overdue', color: 'bg-red-100 text-red-800', title: 'Intermediate due passed and not completed'};
  }
  if(expiry && expiry < now){
    return {label: 'Expired', color: 'bg-red-100 text-red-800', title: 'Expiry passed'};
  }
  if((expiry && expiry <= horizon) || (iDue && iDue <= horizon)){
    return {label: 'Coming Due', color: 'bg-amber-100 text-amber-800', title: 'Due within 90 days'};
  }
  return {label: 'Valid', color: 'bg-green-100 text-green-800', title: 'Valid & outside 90 days'};
}

// ---------- Persistence ----------
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    vessels = raw ? JSON.parse(raw) : [];
  }catch(e){ vessels = []; }
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(vessels));
}

// ---------- Form Rendering ----------
const certSectionsEl = document.getElementById('certSections');
function renderCertSections(){
  certSectionsEl.innerHTML = '';
  CERTS.forEach(c=>{
    const idPrefix = c;
    const el = document.createElement('div');
    el.className = 'p-3 border rounded bg-slate-50';
    el.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">${CERT_LABEL[c]}</div>
        <div class="text-xs text-slate-500">Expiry <span class="text-red-500">*</span></div>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="block text-xs text-slate-600">Issue Date</label>
          <input type="date" id="${idPrefix}-issue" class="mt-1 block w-full rounded-md border-gray-300" />
        </div>
        <div>
          <label class="block text-xs text-slate-600">Expiry Date <span class="text-red-500">*</span></label>
          <input type="date" id="${idPrefix}-expiry" required class="mt-1 block w-full rounded-md border-gray-300" />
        </div>
        <div>
          <label class="block text-xs text-slate-600">Intermediate Due</label>
          <input type="date" id="${idPrefix}-intermediateDue" class="mt-1 block w-full rounded-md border-gray-300" />
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="${idPrefix}-intermediateCompleted" class="h-4 w-4" />
          <label for="${idPrefix}-intermediateCompleted" class="ml-2 text-xs text-slate-600">Intermediate Completed</label>
        </div>
      </div>
    `;
    certSectionsEl.appendChild(el);
  });
}
renderCertSections();

// ---------- Form Actions ----------
const form = document.getElementById('vesselForm');
const vesselNameInput = document.getElementById('vesselName');
const cancelEdit = document.getElementById('cancelEdit');
const clearFormBtn = document.getElementById('clearForm');
form.addEventListener('submit', function(e){
  e.preventDefault();
  const name = vesselNameInput.value.trim();
  if(!name){ alert('Vessel name required'); return; }
  // build certs
  const data = { id: editId || uid(), name, createdAt: Date.now() };
  for(const c of CERTS){
    const issue = document.getElementById(`${c}-issue`).value || '';
    const expiry = document.getElementById(`${c}-expiry`).value || '';
    const iDue = document.getElementById(`${c}-intermediateDue`).value || '';
    const iComp = document.getElementById(`${c}-intermediateCompleted`).checked;
    if(!expiry){ alert(`${CERT_LABEL[c]} expiry date is required.`); return; }
    data[c] = { issue, expiry, intermediateDue: iDue, intermediateCompleted: iComp };
  }

  if(editId){
    const idx = vessels.findIndex(v=>v.id===editId);
    if(idx !== -1) vessels[idx] = data;
    editId = null;
    document.getElementById('formTitle').textContent = 'Add Vessel';
    cancelEdit.classList.add('hidden');
  } else {
    vessels.push(data);
  }
  save();
  renderAll();
  form.reset();
});

cancelEdit.addEventListener('click', ()=>{
  form.reset();
  editId = null;
  document.getElementById('formTitle').textContent = 'Add Vessel';
  cancelEdit.classList.add('hidden');
});

clearFormBtn.addEventListener('click', ()=>{
  form.reset();
  editId = null;
  document.getElementById('formTitle').textContent = 'Add Vessel';
  cancelEdit.classList.add('hidden');
});

// ---------- Table Rendering ----------
const tbody = document.getElementById('tbody');
const totalCountEl = document.getElementById('totalCount');
function renderTable(){
  tbody.innerHTML = '';
  const filtered = vessels.filter(v=>{
    const cls = classifyVessel(v);
    return currentFilter ? cls === currentFilter : true;
  });

  filtered.sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));

  for(const v of filtered){
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-slate-50';
    // name
    const tdName = document.createElement('td');
    tdName.className = 'p-2 align-top';
    tdName.innerHTML = `<div class="font-medium">${escapeHtml(v.name)}</div><div class="text-xs text-slate-500">ID: ${v.id.slice(-6)}</div>`;
    tr.appendChild(tdName);

    // cert columns
    CERTS.forEach(c=>{
      const td = document.createElement('td');
      td.className = 'p-2 align-top';
      const cert = v[c] || {};
      const stat = certStatus(cert);
      const expiryStr = cert.expiry ? formatDate(cert.expiry) : '-';
      const iDueStr = cert.intermediateDue ? formatDate(cert.intermediateDue) : '-';
      td.innerHTML = `
        <div class="flex flex-col gap-1">
          <div class="flex items-center gap-2">
            <span class="pill ${stat.color}">${stat.label}</span>
          </div>
          <div class="text-xs text-slate-500">Expiry: <span class="font-medium">${expiryStr}</span></div>
          <div class="text-xs text-slate-500">Intermediate: <span class="font-medium">${iDueStr}</span></div>
        </div>
      `;
      tr.appendChild(td);
    });

    // actions
    const tdAct = document.createElement('td');
    tdAct.className = 'p-2 align-top';
    tdAct.innerHTML = `
      <div class="flex gap-2">
        <button data-id="${v.id}" class="edit-btn text-xs px-2 py-1 rounded border">Edit</button>
        <button data-id="${v.id}" class="del-btn text-xs px-2 py-1 rounded border text-red-600">Delete</button>
      </div>
    `;
    tr.appendChild(tdAct);
    tbody.appendChild(tr);
  }

  totalCountEl.textContent = filtered.length;
}

// ---------- Edit / Delete ----------
tbody.addEventListener('click', (e)=>{
  const editBtn = e.target.closest('.edit-btn');
  const delBtn = e.target.closest('.del-btn');
  if(editBtn){
    const id = editBtn.getAttribute('data-id');
    startEdit(id);
  } else if(delBtn){
    const id = delBtn.getAttribute('data-id');
    if(confirm('Delete vessel?')){ vessels = vessels.filter(v=>v.id !== id); save(); renderAll(); }
  }
});

function startEdit(id){
  const v = vessels.find(x=>x.id===id);
  if(!v) return;
  editId = id;
  document.getElementById('formTitle').textContent = 'Edit Vessel';
  cancelEdit.classList.remove('hidden');
  vesselNameInput.value = v.name;
  for(const c of CERTS){
    document.getElementById(`${c}-issue`).value = v[c].issue || '';
    document.getElementById(`${c}-expiry`).value = v[c].expiry || '';
    document.getElementById(`${c}-intermediateDue`).value = v[c].intermediateDue || '';
    document.getElementById(`${c}-intermediateCompleted`).checked = !!v[c].intermediateCompleted;
  }
  window.scrollTo({top:0, behavior:'smooth'});
}

// ---------- Summary & Chart (D3) ----------
const countValidEl = document.getElementById('countValid');
const countComingEl = document.getElementById('countComing');
const countExpiredEl = document.getElementById('countExpired');
function computeCounts(){
  const counts = { valid:0, coming:0, expired:0 };
  vessels.forEach(v=>{
    const s = classifyVessel(v);
    counts[s] += 1;
  });
  return counts;
}

function renderSummaryAndChart(){
  const counts = computeCounts();
  countValidEl.textContent = counts.valid;
  countComingEl.textContent = counts.coming;
  countExpiredEl.textContent = counts.expired;
  renderChart(counts);
}

function renderChart(counts){
  // simple D3 bar chart with 3 bars
  const data = [
    {key:'valid', label:'Valid', value: counts.valid},
    {key:'coming', label:'Coming Due', value: counts.coming},
    {key:'expired', label:'Expired', value: counts.expired}
  ];
  // colors
  const COLOR = { valid: '#16a34a', coming: '#d97706', expired: '#dc2626' };

  // clear existing
  const container = d3.select('#chart');
  container.selectAll('*').remove();
  const width = 320, height = 180, margin = {t:10,r:10,b:30,l:40};
  const svg = container.append('svg').attr('width', width).attr('height', height);

  const x = d3.scaleBand().domain(data.map(d=>d.key)).range([margin.l, width - margin.r]).padding(0.3);
  const y = d3.scaleLinear().domain([0, d3.max(data, d=>d.value) || 1]).nice().range([height - margin.b, margin.t]);

  // bars
  svg.selectAll('rect')
    .data(data)
    .join('rect')
    .attr('x', d=>x(d.key))
    .attr('y', d=>y(d.value))
    .attr('width', x.bandwidth())
    .attr('height', d=>Math.max(4, (height - margin.b) - y(d.value)))
    .attr('fill', d=>COLOR[d.key])
    .attr('class','cursor-click')
    .on('click', (event, d)=>{
      currentFilter = d.key;
      renderAll();
    })
    .on('mouseover', function(){ d3.select(this).attr('opacity', 0.8); })
    .on('mouseout', function(){ d3.select(this).attr('opacity', 1); });

  // labels on top of bars
  svg.selectAll('text.barlabel')
    .data(data)
    .join('text')
    .attr('class','barlabel')
    .attr('x', d=>x(d.key) + x.bandwidth()/2)
    .attr('y', d=>y(d.value) - 6)
    .attr('text-anchor','middle')
    .attr('font-size','12px')
    .text(d=>d.value);

  // x axis labels
  svg.append('g')
    .selectAll('text')
    .data(data)
    .join('text')
    .attr('x', d=>x(d.key) + x.bandwidth()/2)
    .attr('y', height - 10)
    .attr('text-anchor','middle')
    .attr('font-size','12px')
    .text(d=>d.label);

  // y axis ticks (simple)
  const yTicks = svg.append('g')
    .attr('transform', `translate(${margin.l},0)`);
  const ticks = y.ticks(4);
  yTicks.selectAll('text').data(ticks).join('text')
    .attr('x', -8).attr('y', d=>y(d))
    .attr('text-anchor','end').attr('font-size','10px')
    .text(d=>d);
}

// ---------- Filter by clicking summary cards ----------
document.getElementById('card-valid').addEventListener('click', ()=>{ currentFilter = 'valid'; renderAll(); });
document.getElementById('card-coming').addEventListener('click', ()=>{ currentFilter = 'coming'; renderAll(); });
document.getElementById('card-expired').addEventListener('click', ()=>{ currentFilter = 'expired'; renderAll(); });
document.getElementById('clearFilter').addEventListener('click', ()=>{ currentFilter = null; renderAll(); });

// ---------- Export CSV ----------
document.getElementById('exportCsv').addEventListener('click', ()=>{
  if(vessels.length === 0){ alert('No data to export'); return; }
  // header
  const header = ['id','name','createdAt'];
  CERTS.forEach(c=>{
    header.push(`${c}_issue`, `${c}_intermediateDue`, `${c}_expiry`, `${c}_intermediateCompleted`);
  });
  const rows = vessels.map(v=>{
    const row = [v.id, v.name, new Date(v.createdAt).toISOString()];
    CERTS.forEach(c=>{
      const cert = v[c] || {};
      row.push(cert.issue || '', cert.intermediateDue || '', cert.expiry || '', cert.intermediateCompleted ? 'TRUE' : 'FALSE');
    });
    return row;
  });
  const csv = [header.join(','), ...rows.map(r=>r.map(cell=>csvEscape(cell)).join(','))].join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `vessels_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

function csvEscape(value){
  if(value === null || value === undefined) return '';
  const s = String(value).replace(/"/g, '""');
  if(s.search(/[",\n]/) >= 0) return `"${s}"`;
  return s;
}

// ---------- Delete All ----------
document.getElementById('clearAll').addEventListener('click', ()=>{
  if(!confirm('Delete ALL vessels? This cannot be undone.')) return;
  vessels = [];
  save();
  renderAll();
});

// ---------- Helpers ----------
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, function(m){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
  });
}

// ---------- Master render ----------
function renderAll(){
  save();
  renderTable();
  renderSummaryAndChart();
  // highlight filter state visually
  ['card-valid','card-coming','card-expired'].forEach(id=>{
    document.getElementById(id).classList.remove('ring','ring-2');
  });
  if(currentFilter){
    document.getElementById(`card-${currentFilter}`).classList.add('ring','ring-2');
  }
  document.getElementById('formTitle').scrollIntoView({behavior:'smooth', block:'nearest'});
}

// ---------- Init ----------
load();
renderAll();
</script>
</body>
</html>
